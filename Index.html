<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Healer's Odyssey - Apex Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
    <style>
        /* Enhanced styles for immersive visuals */
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f172a, #1e3a8a, #111827);
            background-size: 400% 400%;
            color: #e5e7eb;
            overflow-x: hidden;
            animation: gradientBG 15s ease infinite;
            padding-bottom: 4rem;
        }
        h1, h2, h3 {
            font-family: 'Orbitron', sans-serif;
        }
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .modal {
            transition: opacity 0.3s ease-in-out;
        }
        .modal-hidden {
            opacity: 0;
            pointer-events: none;
        }
        .modal-visible {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            transition: transform 0.3s ease-in-out;
        }
        .modal-hidden .modal-content {
            transform: scale(0.9);
        }
        .modal-visible .modal-content {
            transform: scale(1);
        }
        audio {
            display: none;
        }
        .icon {
            display: inline-block;
            width: 1em;
            height: 1em;
            stroke-width: 2;
            vertical-align: -0.125em;
            margin-right: 0.25em;
        }
        .icon-sm {
            width: 0.8em;
            height: 0.8em;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 min-h-screen p-4 md:p-8">

    <!-- Background Music -->
    <audio loop id="bg-music">
        <source src="https://cdn.pixabay.com/download/audio/2023/03/09/audio_3d9f6cc5cf.mp3?filename=medieval-fantasy-epic-142994.mp3" type="audio/mpeg">
    </audio>

    <!-- Game Header -->
    <div class="container mx-auto max-w-3xl">
        <div class="bg-gradient-to-r from-blue-800 to-indigo-900 p-5 md:p-6 rounded-xl shadow-xl mb-8 text-center border border-blue-600/50">
            <h1 class="text-3xl md:text-4xl font-bold text-white mb-1 tracking-wider">Healer's Odyssey</h1>
            <p class="text-base text-blue-300 font-title font-medium">Apex Edition</p>
        </div>

        <!-- World Selection -->
        <div id="world-select-screen" class="">
            <div class="bg-gray-800 bg-opacity-80 backdrop-blur-md p-6 rounded-xl shadow-lg border border-gray-700/50">
                <h2 class="text-2xl font-semibold mb-5 text-center text-blue-300">Choose Your Realm</h2>
                <div id="worlds" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
            </div>
        </div>

        <!-- Mission Selection -->
        <div id="mission-select-screen" class="hidden">
            <div class="bg-gray-800 bg-opacity-90 backdrop-blur-md p-6 rounded-xl shadow-lg border border-gray-700/50">
                <h2 id="world-title" class="text-2xl font-semibold mb-5 text-center text-blue-300"></h2>
                <div id="mission-list" class="space-y-3 mb-5 max-h-[60vh] overflow-y-auto pr-2"></div>
                <button onclick="goBackToWorlds()" class="w-full md:w-auto bg-gray-600 hover:bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg transition duration-200 ease-in-out shadow hover:shadow-md flex items-center justify-center">
                    <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                    Back to Realms
                </button>
            </div>
        </div>

        <!-- Challenge Screen -->
        <div id="challenge-screen" class="hidden">
            <div class="bg-gray-800 bg-opacity-90 backdrop-blur-md p-6 rounded-xl shadow-lg border border-gray-700/50">
                <div class="flex justify-center items-start mb-2 h-14">
                    <div class="w-full text-center">
                        <div id="timer-display" class="text-2xl font-bold text-yellow-400 h-8"></div>
                        <div id="modifier-display" class="text-xs text-purple-300 italic h-6"></div>
                    </div>
                </div>
                <div id="boss-visual" class="w-full flex justify-center items-center mb-4"></div>
                <div id="boss-battle-ui" class="hidden mb-5 space-y-3">
                    <div class="flex justify-between items-center gap-4">
                        <div class="flex-1">
                            <h3 class="text-sm font-semibold text-center text-blue-300 mb-1">Your Focus</h3>
                            <div id="player-focus-bar" class="bar-background">
                                <div id="player-focus-fill" class="bar-fill focus-bar-fill"></div>
                                <span id="player-focus-text" class="bar-text">3 / 3</span>
                            </div>
                        </div>
                        <div class="flex-1">
                            <h3 id="boss-name" class="text-sm font-semibold text-center text-red-400 mb-1">Boss</h3>
                            <div id="boss-hp-bar" class="bar-background">
                                <div id="boss-hp-fill" class="bar-fill hp-bar-fill"></div>
                                <span id="boss-hp-text" class="bar-text">100 / 100</span>
                            </div>
                        </div>
                    </div>
                    <p id="boss-status" class="text-center text-sm text-yellow-400 h-4"></p>
                </div>
                <div id="items-ui" class="mb-4 text-center space-x-2 h-8"></div>
                <h2 id="challenge-title" class="text-xl font-semibold mb-3 text-center text-blue-300"></h2>
                <div id="difficulty-choice" class="mb-5 text-center space-x-3 hidden">
                    <p class="text-sm text-gray-400 mb-2">Choose challenge difficulty:</p>
                    <button onclick="showBossQuestion('easy')" class="difficulty-button easy text-white font-semibold py-1 px-4 rounded-lg border-2 transition duration-200 ease-in-out shadow hover:shadow-md">Easy</button>
                    <button onclick="showBossQuestion('medium')" class="difficulty-button medium text-white font-semibold py-1 px-4 rounded-lg border-2 transition duration-200 ease-in-out shadow hover:shadow-md">Medium</button>
                    <button onclick="showBossQuestion('hard')" class="difficulty-button hard text-white font-semibold py-1 px-4 rounded-lg border-2 transition duration-200 ease-in-out shadow hover:shadow-md">Hard</button>
                </div>
                <p id="question" class="text-lg mb-5 min-h-[3em] text-center bg-gray-700/50 p-3 rounded-lg hidden"></p>
                <div id="options" class="space-y-2 mb-5"></div>
                <p id="feedback" class="text-center font-semibold min-h-[1.5em] mb-5"></p>
                <button id="next-btn" class="hidden w-full bg-green-600 hover:bg-green-500 text-white font-semibold py-2 px-5 rounded-lg transition duration-200 ease-in-out shadow hover:shadow-md flex items-center justify-center mt-4">
                    <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13 7l5 5m0 0l-5 5m5-5H6" />
                    </svg>
                    Continue Journey
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- Enhanced Story Integration ---
        const storyNarrative = {
            intro: "Welcome, Healer. I am the Archivist, the guardian of the Odyssey System. This realm holds the collective knowledge of medicine, but it is under siege by a parasitic Anomaly. Your journey will test your wisdom and resolve. Let us begin.",
            gaia: "The Gaia Sector, once a vibrant simulation of life, now pulses with corrupted rhythms. The Anomaly's touch has turned this realm into a feverish nightmare. Healer, restore balance to this realm.",
            neuro: "Neo-Kyoto, the realm of logic and neural clarity, has become a disorienting maze. Synaptic pathways misfire, and memories flicker with impossible images. The Anomaly seeks to unravel thought itself. Navigate this chaos, Healer.",
            chrono: "Time flows unnaturally in the Chrono Labs. Aging accelerates and reverses, and genetic code flickers between states. The Anomaly distorts the timeline of life and medicine. Confront these temporal challenges, Healer."
        };

        const displayArchivistDialogue = (worldId) => {
            if (player.progress[worldId]?.includes('story_seen')) return; // Prevent repeat story
            const storyText = storyNarrative[worldId];
            if (!storyText) return;
            const dialogueModal = document.createElement('div');
            dialogueModal.className = "fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4";
            dialogueModal.innerHTML = `
                <div class="bg-gray-800 rounded-xl shadow-xl p-6 w-full max-w-lg border border-gray-700/50">
                    <h2 class="text-2xl font-semibold text-blue-300 mb-4">Archivist</h2>
                    <p class="text-gray-300 mb-6">${storyText}</p>
                    <button onclick="closeArchivistDialogue(this, '${worldId}')" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-semibold py-2 px-5 rounded-lg transition duration-200 ease-in-out shadow hover:shadow-md">Continue</button>
                </div>
            `;
            document.body.appendChild(dialogueModal);
        };

        const closeArchivistDialogue = (button, worldId) => {
            const modal = button.closest('.fixed');
            if (modal) modal.remove();
            if (!player.progress[worldId]) player.progress[worldId] = [];
            player.progress[worldId].push('story_seen'); // Mark story as seen
            saveGame();
        };

        // --- Enhanced Visuals ---
        const applyDynamicBackground = () => {
            const body = document.body;
            let hue = 0;
            setInterval(() => {
                hue = (hue + 1) % 360;
                body.style.background = `linear-gradient(135deg, hsl(${hue}, 50%, 15%), hsl(${(hue + 60) % 360}, 50%, 20%), hsl(${(hue + 120) % 360}, 50%, 10%))`;
            }, 100);
        };

        // --- New Gameplay Features ---
        const unlockJournal = () => {
            const journalModal = document.createElement('div');
            journalModal.className = "fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4";
            journalModal.innerHTML = `
                <div class="bg-gray-800 rounded-xl shadow-xl p-6 w-full max-w-lg border border-gray-700/50">
                    <h2 class="text-2xl font-semibold text-blue-300 mb-4">Archivist's Journal</h2>
                    <div id="journal-entries" class="space-y-4">
                        ${Object.entries(storyNarrative).map(([key, text]) => `
                            <div class="bg-gray-700 p-4 rounded-lg">
                                <h3 class="text-lg font-semibold text-blue-400">${key.toUpperCase()}</h3>
                                <p class="text-gray-300">${text}</p>
                            </div>
                        `).join('')}
                    </div>
                    <button onclick="closeJournal(this)" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-semibold py-2 px-5 rounded-lg transition duration-200 ease-in-out shadow hover:shadow-md mt-4">Close</button>
                </div>
            `;
            document.body.appendChild(journalModal);
        };

        const closeJournal = (button) => {
            const modal = button.closest('.fixed');
            if (modal) modal.remove();
        };

        // --- Updated Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // Assign element variables
            levelEl = document.getElementById('level');
            xpEl = document.getElementById('xp');
            nextXpEl = document.getElementById('next-xp');
            streakEl = document.getElementById('streak');
            xpBarFillEl = document.getElementById('xp-bar-fill');
            worldsContainer = document.getElementById('worlds');
            worldSelectScreen = document.getElementById('world-select-screen');
            missionSelectScreen = document.getElementById('mission-select-screen');
            challengeScreen = document.getElementById('challenge-screen');
            worldTitleEl = document.getElementById('world-title');
            missionListEl = document.getElementById('mission-list');
            challengeTitleEl = document.getElementById('challenge-title');
            questionEl = document.getElementById('question');
            optionsEl = document.getElementById('options');
            feedbackEl = document.getElementById('feedback');
            nextBtn = document.getElementById('next-btn');
            bgMusicEl = document.getElementById('bg-music');
            toggleMusicBtn = document.getElementById('toggle-music-btn');
            musicIconOn = document.getElementById('music-icon-on');
            musicIconOff = document.getElementById('music-icon-off');
            musicBtnText = document.getElementById('music-btn-text');
            achievementToastEl = document.getElementById('achievement-toast');
            achievementsModalEl = document.getElementById('achievements-modal');
            achievementsListEl = document.getElementById('achievements-list');
            perksModalEl = document.getElementById('perks-modal');
            perksListEl = document.getElementById('perks-list');
            skillPointsDisplayEl = document.getElementById('skill-points-display');
            settingsModalEl = document.getElementById('settings-modal');
            musicVolumeSlider = document.getElementById('music-volume');
            sfxVolumeSlider = document.getElementById('sfx-volume');
            statsModalEl = document.getElementById('stats-modal');
            statsListEl = document.getElementById('stats-list');
            shopModalEl = document.getElementById('shop-modal');
            shopItemsListEl = document.getElementById('shop-items-list');
            shopCurrencyDisplayEl = document.getElementById('shop-currency-display');
            summaryModalEl = document.getElementById('summary-modal');
            summaryTitleEl = document.getElementById('summary-title');
            summaryDetailsEl = document.getElementById('summary-details');
            bossBattleUI = document.getElementById('boss-battle-ui');
            bossNameEl = document.getElementById('boss-name');
            bossHpFillEl = document.getElementById('boss-hp-fill');
            bossHpTextEl = document.getElementById('boss-hp-text');
            bossStatusEl = document.getElementById('boss-status');
            bossVisualEl = document.getElementById('boss-visual');
            playerFocusFillEl = document.getElementById('player-focus-fill');
            playerFocusTextEl = document.getElementById('player-focus-text');
            itemsUiEl = document.getElementById('items-ui');
            skillPointsStatEl = document.getElementById('skill-points-stat');
            currencyStatEl = document.getElementById('currency-stat');
            timerDisplayEl = document.getElementById('timer-display');
            modifierDisplayEl = document.getElementById('modifier-display');
            difficultyChoiceEl = document.getElementById('difficulty-choice');
            difficultySettingsButtonsEl = document.getElementById('difficulty-settings-buttons');

            // Initialize game state and UI
            initializeSfxVolume();
            initializeMusic();
            checkLevelUp(); // Includes initial stats update
            showWorlds();
            loadSettings(); // Ensure initial difficulty buttons are styled correctly
            applyDynamicBackground(); // Add dynamic background effect
        });

        // --- Add Journal Button ---
        const addJournalButton = () => {
            const journalButton = document.createElement('button');
            journalButton.className = "fixed bottom-4 right-4 bg-blue-600 hover:bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg shadow-lg transition duration-200 ease-in-out";
            journalButton.textContent = "Journal";
            journalButton.onclick = unlockJournal;
            document.body.appendChild(journalButton);
        };

        addJournalButton(); // Add journal button to the UI

        // ...remaining code...
    </script>

</body>
</html>
``` 
