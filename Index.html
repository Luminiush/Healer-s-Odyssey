<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Healer's Odyssey - Apex Edition v6 (Audio Toggle Fix)</title> <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
    <style>
        /* Styles remain the same as previous version */
        body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, #0f172a, #1e3a8a, #111827); background-size: 400% 400%; color: #e5e7eb; overflow-x: hidden; animation: gradientBG 15s ease infinite; padding-bottom: 4rem; }
        h1, h2, h3 { font-family: 'Orbitron', sans-serif; }
        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-6px); } 20%, 40%, 60%, 80% { transform: translateX(6px); } }
        .shake { animation: shake 0.4s ease-in-out; }
        @keyframes pulse-glow { 0% { box-shadow: 0 0 6px rgba(59, 130, 246, 0.6), 0 0 12px rgba(59, 130, 246, 0.5); } 50% { box-shadow: 0 0 18px rgba(59, 130, 246, 0.8), 0 0 30px rgba(59, 130, 246, 0.7); } 100% { box-shadow: 0 0 6px rgba(59, 130, 246, 0.6), 0 0 12px rgba(59, 130, 246, 0.5); } }
        .pulse-glow-animation { animation: pulse-glow 2.5s infinite ease-in-out; }
        .bar-background { background-color: #374151; border-radius: 9999px; overflow: hidden; height: 1.25rem; border: 1px solid #4b5563; position: relative; box-shadow: inset 0 1px 3px rgba(0,0,0,0.4); }
        .bar-fill { height: 100%; transition: width 0.5s ease-in-out; border-radius: 9999px 0 0 9999px; box-shadow: inset 0 -1px 2px rgba(0,0,0,0.2); background-image: linear-gradient(45deg, rgba(255,255,255,.1) 25%, transparent 25%, transparent 50%, rgba(255,255,255,.1) 50%, rgba(255,255,255,.1) 75%, transparent 75%, transparent); background-size: 0.75rem 0.75rem; }
        .bar-text { position: absolute; width: 100%; text-align: center; left: 0; top: 50%; transform: translateY(-50%); color: white; font-size: 0.75rem; font-weight: 600; text-shadow: 1px 1px 1px rgba(0,0,0,0.8); line-height: 1; }
        .hp-bar-fill { background-color: #dc2626; }
        .focus-bar-fill { background-color: #2563eb; }
        .xp-bar-background { background-color: #374151; border-radius: 9999px; overflow: hidden; height: 0.75rem; border: 1px solid #4b5563; }
        .xp-bar-fill { background-color: #facc15; height: 100%; transition: width 0.6s ease-out; border-radius: 9999px; }
        @keyframes level-up-pop { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.2); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }
        .level-up-animation { animation: level-up-pop 0.5s ease-out; }
        @keyframes slide-in-out { 0% { transform: translateY(-100%); opacity: 0; } 15% { transform: translateY(0); opacity: 1; } 85% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(-100%); opacity: 0; } }
        #achievement-toast { position: fixed; top: 1rem; left: 50%; transform: translateX(-50%); z-index: 1000; animation: slide-in-out 4s ease-in-out forwards; }
        .modal { transition: opacity 0.3s ease-in-out; }
        .modal-hidden { opacity: 0; pointer-events: none; }
        .modal-visible { opacity: 1; pointer-events: auto; }
        .modal-content { transition: transform 0.3s ease-in-out; }
        .modal-hidden .modal-content { transform: scale(0.9); }
        .modal-visible .modal-content { transform: scale(1); }
        audio { display: none; }
        .icon { display: inline-block; width: 1em; height: 1em; stroke-width: 2; vertical-align: -0.125em; margin-right: 0.25em; }
        .icon-sm { width: 0.8em; height: 0.8em; }
        .perk-button:disabled { background-color: #4b5563; border-color: #6b7280; color: #9ca3af; cursor: not-allowed; }
        .perk-button:disabled:hover { background-color: #4b5563; }
        .item-button { /* Base styles */ }
        .item-button:disabled { opacity: 0.5; cursor: not-allowed; }
        input[type=range]::-webkit-slider-thumb { appearance: none; width: 16px; height: 16px; background: #60a5fa; border-radius: 50%; cursor: pointer; margin-top: -4px; }
        input[type=range]::-moz-range-thumb { width: 16px; height: 16px; background: #60a5fa; border-radius: 50%; cursor: pointer; border: none; }
        .hint-removed { opacity: 0.4 !important; text-decoration: line-through; background-color: #4b5563 !important; border-color: #6b7280 !important; cursor: not-allowed; }
        #timer-display { font-family: 'Orbitron', sans-serif; }
        #boss-visual { transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out; opacity: 0; transform: scale(0.8); }
        #boss-visual.visible { opacity: 1; transform: scale(1); }
        #boss-visual svg { width: 50px; height: 50px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)); }
        #boss-visual svg path { transition: fill 0.2s ease, stroke 0.2s ease; stroke-width: 1.5; }
        #boss-visual.hit svg path { fill: #ef4444; stroke: #f87171; }
        @keyframes slow-pulse { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.05); opacity: 0.85; } }
        .animate-slow-pulse { animation: slow-pulse 3s infinite ease-in-out; }
        .difficulty-button { /* Base styles */ }
        .difficulty-button.easy { background-color: #10b981; border-color: #059669; } /* Green */
        .difficulty-button.easy:hover { background-color: #059669; }
        .difficulty-button.medium { background-color: #f59e0b; border-color: #d97706; } /* Amber */
        .difficulty-button.medium:hover { background-color: #d97706; }
        .difficulty-button.hard { background-color: #ef4444; border-color: #dc2626; } /* Red */
        .difficulty-button.hard:hover { background-color: #dc2626; }
        .shop-buy-button:disabled { background-color: #4b5563; cursor: not-allowed; }
        .shop-buy-button:disabled:hover { background-color: #4b5563; }
        .difficulty-setting-button.active { background-color: #4f46e5 !important; color: white !important; border-color: #6366f1 !important; box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.5); }

    </style>
    <script>
        tailwind.config = { /* ... same as before ... */ };
    </script>
</head>
<body class="bg-gray-900 text-gray-200 min-h-screen p-4 md:p-8">

    <audio loop id="bg-music"> <source src="https://cdn.pixabay.com/download/audio/2023/03/09/audio_3d9f6cc5cf.mp3?filename=medieval-fantasy-epic-142994.mp3" type="audio/mpeg"> </audio>
    <div id="achievement-toast" class="hidden"></div>

    <div id="achievements-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4"> <div class="modal-content bg-gray-800 rounded-xl shadow-xl p-6 w-full max-w-lg border border-gray-700/50 max-h-[80vh] overflow-y-auto"> <div class="flex justify-between items-center mb-4"> <h2 class="text-2xl font-semibold text-blue-300">Achievements</h2> <button onclick="closeModal('achievements-modal')" class="text-gray-400 hover:text-white transition"> <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg> </button> </div> <div id="achievements-list" class="space-y-3"> <p class="text-gray-400 italic">No achievements unlocked yet.</p> </div> </div> </div>
    <div id="perks-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4"> <div class="modal-content bg-gray-800 rounded-xl shadow-xl p-6 w-full max-w-lg border border-gray-700/50 max-h-[80vh] overflow-y-auto"> <div class="flex justify-between items-center mb-4"> <h2 class="text-2xl font-semibold text-blue-300">Perks</h2> <button onclick="closeModal('perks-modal')" class="text-gray-400 hover:text-white transition"> <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg> </button> </div> <p class="mb-4 text-center text-yellow-400">Skill Points Available: <span id="skill-points-display" class="font-bold">0</span></p> <div id="perks-list" class="space-y-3"> <p class="text-gray-400 italic">No perks available yet.</p> </div> </div> </div>
    <div id="settings-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="modal-content bg-gray-800 rounded-xl shadow-xl p-6 w-full max-w-md border border-gray-700/50">
            <div class="flex justify-between items-center mb-6"> <h2 class="text-2xl font-semibold text-blue-300">Settings</h2> <button onclick="closeModal('settings-modal')" class="text-gray-400 hover:text-white transition"> <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg> </button> </div>
            <div class="space-y-6"> <div> <label for="music-volume" class="block text-sm font-medium text-gray-300 mb-1">Music Volume</label> <input type="range" id="music-volume" min="0" max="1" step="0.05" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer range-lg accent-blue-500"> </div>
                <div> <label for="sfx-volume" class="block text-sm font-medium text-gray-300 mb-1">Sound Effects Volume</label> <input type="range" id="sfx-volume" min="0" max="1" step="0.05" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer range-lg accent-blue-500"> </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Game Difficulty</label>
                    <div class="flex justify-center space-x-3" id="difficulty-settings-buttons">
                        <button onclick="setDifficulty('easy')" data-difficulty="easy" class="difficulty-setting-button flex-1 bg-gray-600 hover:bg-gray-500 text-white text-xs font-semibold py-1.5 px-3 rounded-full transition duration-200 border-2 border-transparent">Easy</button>
                        <button onclick="setDifficulty('normal')" data-difficulty="normal" class="difficulty-setting-button flex-1 bg-gray-600 hover:bg-gray-500 text-white text-xs font-semibold py-1.5 px-3 rounded-full transition duration-200 border-2 border-transparent">Normal</button>
                        <button onclick="setDifficulty('hard')" data-difficulty="hard" class="difficulty-setting-button flex-1 bg-gray-600 hover:bg-gray-500 text-white text-xs font-semibold py-1.5 px-3 rounded-full transition duration-200 border-2 border-transparent">Hard</button>
                    </div>
                </div>
                 <div class="pt-4 border-t border-gray-700/50">
                     <button onclick="resetGame()" class="w-full bg-red-700 hover:bg-red-600 text-white font-semibold py-2 px-5 rounded-lg transition duration-200 ease-in-out shadow hover:shadow-md flex items-center justify-center">
                         <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                         Reset Game Data
                     </button>
                     <p class="text-xs text-center text-gray-500 mt-2">Warning: This will erase all progress, levels, perks, items, and achievements.</p>
                 </div>
            </div>
        </div>
    </div>
    <div id="stats-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4"> <div class="modal-content bg-gray-800 rounded-xl shadow-xl p-6 w-full max-w-lg border border-gray-700/50 max-h-[80vh] overflow-y-auto"> <div class="flex justify-between items-center mb-4"> <h2 class="text-2xl font-semibold text-blue-300">Player Statistics</h2> <button onclick="closeModal('stats-modal')" class="text-gray-400 hover:text-white transition"> <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg> </button> </div> <div id="stats-list" class="space-y-2 text-sm"> <p class="text-gray-400 italic">No statistics recorded yet.</p> </div> </div> </div>
    <div id="shop-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4"> <div class="modal-content bg-gray-800 rounded-xl shadow-xl p-6 w-full max-w-lg border border-gray-700/50 max-h-[80vh] overflow-y-auto"> <div class="flex justify-between items-center mb-4"> <h2 class="text-2xl font-semibold text-blue-300">Item Shop</h2> <button onclick="closeModal('shop-modal')" class="text-gray-400 hover:text-white transition"> <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg> </button> </div> <p class="mb-4 text-center text-yellow-400">Credits Available: <span id="shop-currency-display" class="font-bold">0</span> 🪙</p> <div id="shop-items-list" class="space-y-3"> <p class="text-gray-400 italic">Shop is empty.</p> </div> </div> </div>
    <div id="summary-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4"> <div class="modal-content bg-gray-800 rounded-xl shadow-xl p-6 w-full max-w-md border border-gray-700/50"> <div class="flex justify-between items-center mb-4"> <h2 id="summary-title" class="text-2xl font-semibold text-blue-300">Mission Complete!</h2> <button onclick="closeSummaryModal()" class="text-gray-400 hover:text-white transition"> <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg> </button> </div> <div id="summary-details" class="space-y-2 text-sm mb-6"> </div> <button onclick="closeSummaryModal()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-semibold py-2 px-5 rounded-lg transition duration-200 ease-in-out shadow hover:shadow-md flex items-center justify-center"> Continue </button> </div> </div>


    <div class="container mx-auto max-w-3xl">
        <div class="bg-gradient-to-r from-blue-800 to-indigo-900 p-5 md:p-6 rounded-xl shadow-xl mb-8 text-center border border-blue-600/50">
            <h1 class="text-3xl md:text-4xl font-bold text-white mb-1 tracking-wider">Healer's Odyssey</h1>
            <p class="text-base text-blue-300 font-title font-medium">Apex Edition v6</p>
        </div>

        <div>
            <div id="world-select-screen" class=""> <div class="bg-gray-800 bg-opacity-80 backdrop-blur-md p-6 rounded-xl shadow-lg border border-gray-700/50 pulse-glow-animation"> <h2 class="text-2xl font-semibold mb-5 text-center text-blue-300">Choose Your Realm</h2> <div id="worlds" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div> </div> </div>
            <div id="mission-select-screen" class="hidden"> <div class="bg-gray-800 bg-opacity-90 backdrop-blur-md p-6 rounded-xl shadow-lg border border-gray-700/50"> <h2 id="world-title" class="text-2xl font-semibold mb-5 text-center text-blue-300"></h2> <div id="mission-list" class="space-y-3 mb-5 max-h-[60vh] overflow-y-auto pr-2"></div> <button onclick="goBackToWorlds()" class="w-full md:w-auto bg-gray-600 hover:bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg transition duration-200 ease-in-out shadow hover:shadow-md flex items-center justify-center"> <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg> Back to Realms </button> </div> </div>
            <div id="challenge-screen" class="hidden">
                <div class="bg-gray-800 bg-opacity-90 backdrop-blur-md p-6 rounded-xl shadow-lg border border-gray-700/50">
                    <div class="flex justify-center items-start mb-2 h-14"> <div class="w-full text-center">
                            <div id="timer-display" class="text-2xl font-bold text-yellow-400 h-8"></div>
                            <div id="modifier-display" class="text-xs text-purple-300 italic h-6"></div>
                        </div>
                    </div>
                    <div id="boss-visual" class="w-full flex justify-center items-center mb-4"></div>
                    <div id="boss-battle-ui" class="hidden mb-5 space-y-3"> <div class="flex justify-between items-center gap-4"> <div class="flex-1"> <h3 class="text-sm font-semibold text-center text-blue-300 mb-1">Your Focus</h3> <div id="player-focus-bar" class="bar-background"> <div id="player-focus-fill" class="bar-fill focus-bar-fill"></div> <span id="player-focus-text" class="bar-text">3 / 3</span> </div> </div> <div class="flex-1"> <h3 id="boss-name" class="text-sm font-semibold text-center text-red-400 mb-1">Boss</h3> <div id="boss-hp-bar" class="bar-background"> <div id="boss-hp-fill" class="bar-fill hp-bar-fill"></div> <span id="boss-hp-text" class="bar-text">100 / 100</span> </div> </div> </div> <p id="boss-status" class="text-center text-sm text-yellow-400 h-4"></p> </div>
                    <div id="items-ui" class="mb-4 text-center space-x-2 h-8"></div>
                    <h2 id="challenge-title" class="text-xl font-semibold mb-3 text-center text-blue-300"></h2>
                    <div id="difficulty-choice" class="mb-5 text-center space-x-3 hidden"> <p class="text-sm text-gray-400 mb-2">Choose challenge difficulty:</p> <button onclick="showBossQuestion('easy')" class="difficulty-button easy text-white font-semibold py-1 px-4 rounded-lg border-2 transition duration-200 ease-in-out shadow hover:shadow-md">Easy</button> <button onclick="showBossQuestion('medium')" class="difficulty-button medium text-white font-semibold py-1 px-4 rounded-lg border-2 transition duration-200 ease-in-out shadow hover:shadow-md">Medium</button> <button onclick="showBossQuestion('hard')" class="difficulty-button hard text-white font-semibold py-1 px-4 rounded-lg border-2 transition duration-200 ease-in-out shadow hover:shadow-md">Hard</button> </div>
                    <p id="question" class="text-lg mb-5 min-h-[3em] text-center bg-gray-700/50 p-3 rounded-lg hidden"></p>
                    <div id="options" class="space-y-2 mb-5"></div>
                    <p id="feedback" class="text-center font-semibold min-h-[1.5em] mb-5"></p>
                    <button id="next-btn" class="hidden w-full bg-green-600 hover:bg-green-500 text-white font-semibold py-2 px-5 rounded-lg transition duration-200 ease-in-out shadow hover:shadow-md flex items-center justify-center mt-4"> <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M13 7l5 5m0 0l-5 5m5-5H6" /></svg> Continue Journey </button>
                </div>
            </div>
        </div>

        <div class="mt-8 bg-gray-800/80 backdrop-blur-md p-5 rounded-xl shadow-lg border border-gray-700/50">
            <h2 class="text-xl font-semibold mb-4 text-center text-blue-300">Your Progress</h2>
            <div class="grid grid-cols-2 md:grid-cols-6 gap-4 text-center items-center"> <div> <p class="text-xs text-gray-400 uppercase tracking-wider">Level</p> <p id="level" class="text-3xl font-bold text-green-400 font-title">1</p> </div>
                <div class="col-span-2 md:col-span-1"> <p class="text-xs text-gray-400 uppercase tracking-wider mb-1">XP</p> <div class="xp-bar-background mb-1"> <div id="xp-bar-fill" class="xp-bar-fill" style="width: 0%;"></div> </div> <p class="text-xs font-semibold"><span id="xp">0</span> / <span id="next-xp">100</span></p> </div>
                <div> <p class="text-xs text-gray-400 uppercase tracking-wider">Streak</p> <p id="streak" class="text-3xl font-bold text-yellow-400 font-title">0</p> </div>
                 <div> <p class="text-xs text-gray-400 uppercase tracking-wider">Credits</p> <p id="currency-stat" class="text-2xl font-bold text-yellow-300 font-title">0 🪙</p> </div> <div> <p class="text-xs text-gray-400 uppercase tracking-wider">Skill Pts</p> <p id="skill-points-stat" class="text-3xl font-bold text-purple-400 font-title">0</p> </div>
                <div class="col-span-2 md:col-span-1 flex flex-col items-center space-y-2">
                     <button onclick="openModal('shop-modal')" class="w-full bg-green-700 hover:bg-green-600 text-white text-xs font-semibold py-1.5 px-3 rounded-full transition duration-200 flex items-center justify-center"> <svg class="icon icon-sm" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" /></svg> Shop </button> <button onclick="openModal('perks-modal')" class="w-full bg-purple-600 hover:bg-purple-500 text-white text-xs font-semibold py-1.5 px-3 rounded-full transition duration-200 flex items-center justify-center"> <svg class="icon icon-sm" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.196-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" /></svg> Perks </button>
                     <button onclick="openModal('achievements-modal')" class="w-full bg-yellow-600 hover:bg-yellow-500 text-gray-900 text-xs font-semibold py-1.5 px-3 rounded-full transition duration-200 flex items-center justify-center"> <svg class="icon icon-sm" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg> Achievements </button>
                     <button onclick="openModal('stats-modal')" class="w-full bg-cyan-600 hover:bg-cyan-500 text-white text-xs font-semibold py-1.5 px-3 rounded-full transition duration-200 flex items-center justify-center"> <svg class="icon icon-sm" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16 8v8m-4-5v5m-4-2v2m-2 4h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg> Stats </button>
                     <button onclick="openModal('settings-modal')" class="w-full bg-gray-600 hover:bg-gray-500 text-white text-xs font-semibold py-1.5 px-3 rounded-full transition duration-200 flex items-center justify-center"> <svg class="icon icon-sm" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg> Settings </button>
                     <button id="toggle-music-btn" onclick="toggleMusic()" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white text-xs font-semibold py-1.5 px-3 rounded-full transition duration-200 flex items-center justify-center"> <svg id="music-icon-on" class="icon icon-sm" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" /></svg> <svg id="music-icon-off" class="icon icon-sm hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M5.586 15L4 16.586a1 1 0 01-1.414-1.414L6.172 11.5a1 1 0 011.414 0L11 14.914l3.586-3.586a1 1 0 01-1.414 1.414L12.414 16.5 16 19.086a1 1 0 01-1.414 1.414L11 16.914l-3.586 3.586a1 1 0 01-1.414-1.414L9.586 15zM9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" /></svg> <span id="music-btn-text" class="ml-1">On</span> </button>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- Sound Synthesis Setup ---
        const clickSynth = new Tone.Synth().toDestination();
        const correctSynth = new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.01, decay: 0.1, sustain: 0.1, release: 0.2 } }).toDestination();
        const incorrectSynth = new Tone.Synth({ oscillator: { type: 'sawtooth' }, envelope: { attack: 0.02, decay: 0.4, sustain: 0, release: 0.1 } }).toDestination();
        const levelUpSynth = new Tone.Sequence((time, note) => { correctSynth.triggerAttackRelease(note, "16n", time); }, ["C4", "E4", "G4", "C5", "G5"], "16n").start(0);
        levelUpSynth.loop = false;
        const bossHitSynth = new Tone.Synth({ oscillator: { type: 'square' }, volume: -6, envelope: { attack: 0.01, decay: 0.2, sustain: 0, release: 0.1 } }).toDestination();
        const playerHitSynth = new Tone.Synth({ oscillator: { type: 'fmsquare' }, volume: -3, modulationIndex: 5, envelope: { attack: 0.05, decay: 0.3, sustain: 0, release: 0.1 } }).toDestination();
        const defeatSynth = new Tone.Synth({ oscillator: { type: 'pwm', modulationFrequency: 0.5 }, volume: -3, envelope: { attack: 0.1, decay: 1.0, sustain: 0, release: 0.2 } }).toDestination();
        const achievementSynth = new Tone.Synth({ oscillator: { type: 'triangle' }, volume: -4, envelope: { attack: 0.01, decay: 0.2, sustain: 0.3, release: 0.3 } }).toDestination();
        const itemUseSynth = new Tone.Synth({ oscillator: { type: 'pulse', width: 0.3 }, volume: -5, envelope: { attack: 0.01, decay: 0.1, sustain: 0.1, release: 0.1 } }).toDestination();
        const perkUnlockSynth = new Tone.Synth({ oscillator: { type: 'triangle8' }, volume: -4, envelope: { attack: 0.02, decay: 0.3, sustain: 0.2, release: 0.3 } }).toDestination();
        const timerTickSynth = new Tone.Synth({ oscillator: { type: 'sine' }, volume: -15, envelope: { attack: 0.005, decay: 0.05, sustain: 0, release: 0.05 } }).toDestination(); // Timer tick sound
        const timerEndSynth = new Tone.Synth({ oscillator: { type: 'square' }, volume: -8, envelope: { attack: 0.01, decay: 0.5, sustain: 0, release: 0.1 } }).toDestination(); // Timer end sound
        const buyItemSynth = new Tone.Synth({ oscillator: { type: 'sine' }, volume: -8, envelope: { attack: 0.01, decay: 0.1, sustain: 0.1, release: 0.1 } }).toDestination(); // Buy sound


        // --- Master Volume Control ---
        const sfxDestination = Tone.Destination;

        // --- PlaySound Function ---
        const playSound = (type) => {
            Tone.start().then(() => {
                try {
                    if (type === 'click') clickSynth.triggerAttackRelease("F5", "32n");
                    else if (type === 'correct') correctSynth.triggerAttackRelease("C5", "16n");
                    else if (type === 'incorrect') incorrectSynth.triggerAttackRelease("G2", "8n");
                    else if (type === 'levelUp') levelUpSynth.start(Tone.now());
                    else if (type === 'bossHit') bossHitSynth.triggerAttackRelease("A2", "8n", Tone.now() + 0.05);
                    else if (type === 'playerHit') playerHitSynth.triggerAttackRelease("E2", "4n");
                    else if (type === 'defeat') defeatSynth.triggerAttackRelease("C2", "2n");
                    else if (type === 'achievement') achievementSynth.triggerAttackRelease("A4", "8n");
                    else if (type === 'itemUse') itemUseSynth.triggerAttackRelease("G4", "16n");
                    else if (type === 'perkUnlock') { perkUnlockSynth.triggerAttackRelease("C4", "8n", Tone.now() + 0.05); perkUnlockSynth.triggerAttackRelease("G4", "8n", Tone.now() + 0.2); }
                    else if (type === 'timerTick') timerTickSynth.triggerAttackRelease("A5", "32n");
                    else if (type === 'timerEnd') timerEndSynth.triggerAttackRelease("D3", "4n");
                    else if (type === 'buyItem') buyItemSynth.triggerAttackRelease("E5", "16n");
                } catch (error) { console.error(`Tone.js error playing '${type}':`, error); }
            }).catch(error => { console.error("Failed to start Tone.js audio context:", error); });
        };


        // --- Game State & Data ---
        const SAVE_KEY = "healers_odyssey_save_v7"; // Incremented save key
        let player = JSON.parse(localStorage.getItem(SAVE_KEY)) || {
            level: 1, xp: 0, streak: 0, progress: {}, musicOn: true,
            unlockedAchievements: [], skillPoints: 0, unlockedPerks: [],
            inventory: { focusVial: 1, hintToken: 1 }, // Start with 1 of each for testing
            settings: { musicVolume: 0.5, sfxVolume: 0.8, difficulty: 'normal' }, // Added difficulty setting
            stats: { missionsCompleted: 0, bossesDefeated: 0, totalCorrect: 0, totalIncorrect: 0, itemsUsed: 0, vialsUsed: 0, hintsUsed: 0, highestStreak: 0, perfectBossWins: 0, timedWins: 0, itemsBought: 0 }, // Added itemsBought
            currency: 100 // Start with some currency for testing shop
        };
        const xpPerLevel = lvl => Math.floor(100 * Math.pow(1.25, lvl - 1));
        const saveGame = () => localStorage.setItem(SAVE_KEY, JSON.stringify(player));

        // --- Game Content (Updated Chrono Labs & Boss Difficulty) ---
         const gameData = {
            items: {
                focusVial: { name: 'Focus Vial', description: 'Restores 1 Focus during a boss battle.', icon: '🧪', price: 50 }, // Added price
                hintToken: { name: 'Hint Token', description: 'Removes one incorrect answer choice.', icon: '💡', price: 75 }, // Added price
                shieldCharm: { name: 'Shield Charm', description: 'Blocks the next Focus loss (consumed).', icon: '🛡️', price: 150 } // Added new item
            },
            perks: { resilience1: { name: "Resilience I", description: "+1 Max Focus", cost: 1, requiresLevel: 2, type: 'passive', effectTarget: 'maxFocus', value: 1 }, learningBoost1: { name: "Learning Boost I", description: "+10% XP from correct answers", cost: 1, requiresLevel: 3, type: 'passive', effectTarget: 'xpModifier', value: 0.1 }, resilience2: { name: "Resilience II", description: "+1 Max Focus (Total +2)", cost: 2, requiresLevel: 5, requiresPerk: 'resilience1', type: 'passive', effectTarget: 'maxFocus', value: 1 }, learningBoost2: { name: "Learning Boost II", description: "+20% XP from correct answers (Total +30%)", cost: 2, requiresLevel: 6, requiresPerk: 'learningBoost1', type: 'passive', effectTarget: 'xpModifier', value: 0.2 }, streakSaver: { name: "Streak Saver", description: "First wrong answer in a streak doesn't reset it (once per session)", cost: 3, requiresLevel: 7, type: 'passive', effectTarget: 'streakSaver', value: true }, scavenger: { name: "Scavenger", description: "Slightly increases chance of finding items.", cost: 2, requiresLevel: 4, type: 'passive', effectTarget: 'itemDropRate', value: 0.03 }, },
            achievements: { gaia_cleared: { name: "Gaia Sector Cleared", description: "Defeat the Heartless Titan.", condition: (p) => p.progress?.gaia?.includes('g_boss') }, neuro_cleared: { name: "Neo-Kyoto Circuits Cleared", description: "Defeat The Logic Core.", condition: (p) => p.progress?.neuro?.includes('n_boss') }, chrono_cleared: { name: "Chrono Labs Secured", description: "Defeat the Temporal Anomaly.", condition: (p) => p.progress?.chrono?.includes('c_boss') }, level_5: { name: "Adept Healer", description: "Reach Level 5.", condition: (p) => p.level >= 5 }, level_10: { name: "Master Healer", description: "Reach Level 10.", condition: (p) => p.level >= 10 }, streak_10: { name: "Focused Mind", description: "Achieve a streak of 10 correct answers.", condition: (p) => p.streak >= 10 }, first_perk: { name: "Enhanced", description: "Unlock your first perk.", condition: (p) => p.unlockedPerks.length > 0 }, used_vial: { name: "Quick Fix", description: "Use a Focus Vial.", condition: (p) => p.stats?.vialsUsed > 0 }, used_hint: { name: "Illuminated", description: "Use a Hint Token.", condition: (p) => p.stats?.hintsUsed > 0 }, perfect_boss: { name: "Flawless Victory", description: "Defeat a boss without losing any Focus.", condition: (p) => p.stats?.perfectBossWins > 0 }, timed_win: { name: "Swift Diagnosis", description: "Complete a timed mission successfully.", condition: (p) => p.stats?.timedWins > 0 }, shopper: { name: "Resourceful", description: "Buy an item from the shop.", condition: (p) => p.stats?.itemsBought > 0 } },
             modifiers: {
                doubleXp: { id: 'doubleXp', name: "XP Surge", description: "Earn double XP!", apply: (mission) => ({ ...mission, xp: (mission.xp || 15) * 2, modifierId: 'doubleXp' }) },
                lowFocus: { id: 'lowFocus', name: "Focus Drain", description: "Start boss with -1 Max Focus.", apply: (mission) => ({ ...mission, playerBaseFocus: Math.max(1, (mission.playerBaseFocus || 3) - 1), modifierId: 'lowFocus' }) },
                timePressure: { id: 'timePressure', name: "Time Pressure", description: "Answer within 15 seconds!", apply: (mission) => ({ ...mission, timeLimit: 15, modifierId: 'timePressure' }) },
                fragile: { id: 'fragile', name: "Fragile", description: "Lose 2 Focus on incorrect boss answers!", apply: (mission) => ({ ...mission, baseFocusLossMultiplier: 2, modifierId: 'fragile'})},
             },
            gaia: { name: "Gaia Sector 🌿", icon: '🌿', order: 1, missions: [ { id: "g1", name: "The Heart's Warning", q: "Primary cause of acute myocardial infarction?", o: ["Coronary artery thrombosis", "Severe asthma attack", "Common cold complications", "Ischemic stroke"], a: "Coronary artery thrombosis", xp: 20 }, { id: "g2", name: "The Blood Code", q: "Essential vitamin for blood clotting?", o: ["Vitamin K", "Vitamin C", "Vitamin D", "Vitamin B12"], a: "Vitamin K", xp: 20, timeLimit: 20 }, { id: "g3", name: "First Response Protocol", q: "Initial test for acute chest pain in ER?", o: ["Electrocardiogram (ECG)", "MRI", "CT scan", "Echocardiogram"], a: "Electrocardiogram (ECG)", xp: 25 }, { id: "g_boss", name: "Heartless Titan", boss: true, hp: 100, playerBaseFocus: 3, rewards: { items: { focusVial: 1 }, currency: 50 }, svgPath: "M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z", questions: [ { easy: { q: "What does 'MI' stand for in STEMI?", o: ["Myocardial Infarction", "Multiple Injuries", "Medical Intervention"], a: "Myocardial Infarction", damage: 25, focusLoss: 1 }, medium: { q: "What does STEMI specifically indicate on an ECG?", o: ["ST segment elevation", "Presence of Q waves", "T wave inversion"], a: "ST segment elevation", damage: 35, focusLoss: 1 }, hard: { q: "Which coronary artery blockage typically causes an anterior STEMI?", o: ["Left Anterior Descending (LAD)", "Right Coronary Artery (RCA)", "Circumflex Artery"], a: "Left Anterior Descending (LAD)", damage: 50, focusLoss: 2 } }, { easy: { q: "Is Aspirin used in STEMI treatment?", o: ["Yes", "No"], a: "Yes", damage: 25, focusLoss: 1 }, medium: { q: "What is the primary goal of immediate STEMI treatment?", o: ["Pain relief", "Reperfusion", "Lowering blood pressure"], a: "Reperfusion", damage: 35, focusLoss: 1 }, hard: { q: "What does 'door-to-balloon' time refer to in STEMI care?", o: ["Time to administer oxygen", "Time from hospital arrival to PCI", "Time to give aspirin"], a: "Time from hospital arrival to PCI", damage: 50, focusLoss: 2 } }, { easy: { q: "Does an ECG measure heart electricity?", o: ["Yes", "No"], a: "Yes", damage: 25, focusLoss: 1 }, medium: { q: "Which leads on an ECG typically show an inferior MI?", o: ["V1-V4", "I, aVL", "II, III, aVF"], a: "II, III, aVF", damage: 35, focusLoss: 1 }, hard: { q: "Reciprocal changes (ST depression) in leads V1-V3 might indicate a STEMI in which area?", o: ["Anterior", "Lateral", "Posterior"], a: "Posterior", damage: 50, focusLoss: 2 } } ], xp: 100 } ] },
            neuro: { name: "Neo-Kyoto Circuits 🧠", icon: '🧠', order: 2, unlocksAfter: 'gaia', missions: [ { id: "n1", name: "Sight and Cortex", q: "Which lobe processes visual info?", o: ["Occipital lobe", "Temporal lobe", "Parietal lobe", "Frontal lobe"], a: "Occipital lobe", xp: 20 }, { id: "n2", name: "Motor Control Secrets", q: "Parkinson's involves loss of which neurotransmitter?", o: ["Dopamine", "Serotonin", "GABA", "Acetylcholine"], a: "Dopamine", xp: 20 }, { id: "n3", name: "The Relay Gate", q: "Major relay station for sensory info?", o: ["Thalamus", "Hypothalamus", "Cerebellum", "Amygdala"], a: "Thalamus", xp: 25 }, { id: "n_boss", name: "The Logic Core", boss: true, hp: 120, playerBaseFocus: 3, rewards: { currency: 75 }, svgPath: "M5 11a7 7 0 1114 0 7 7 0 01-14 0z M4.5 11c0-3.866 3.134-7 7-7s7 3.134 7 7M5 11v2.5a6.5 6.5 0 0013 0V11", questions: [ { easy: { q: "Which lobe is primarily for planning?", o: ["Frontal", "Temporal", "Occipital"], a: "Frontal", damage: 30, focusLoss: 1 }, medium: { q: "Executive functions like decision-making are most associated with which cortex?", o: ["Prefrontal Cortex", "Motor Cortex", "Somatosensory Cortex"], a: "Prefrontal Cortex", damage: 40, focusLoss: 1 }, hard: { q: "Damage to the dorsolateral prefrontal cortex might impair which specific function?", o: ["Working memory", "Facial recognition", "Hearing"], a: "Working memory", damage: 55, focusLoss: 2 } }, { easy: { q: "Does EEG measure brain waves?", o: ["Yes", "No"], a: "Yes", damage: 30, focusLoss: 1 }, medium: { q: "Which type of brain wave is typically dominant during relaxed wakefulness?", o: ["Alpha", "Beta", "Delta"], a: "Alpha", damage: 40, focusLoss: 1 }, hard: { q: "What does a flat line on an EEG usually signify?", o: ["Deep sleep", "Seizure activity", "Brain death"], a: "Brain death", damage: 55, focusLoss: 2 } }, { easy: { q: "Are anticonvulsants used for seizures?", o: ["Yes", "No"], a: "Yes", damage: 30, focusLoss: 1 }, medium: { q: "Phenytoin, a common anticonvulsant, primarily acts on which ion channels?", o: ["Sodium channels", "Potassium channels", "Calcium channels"], a: "Sodium channels", damage: 40, focusLoss: 1 }, hard: { q: "What is a potential serious side effect of Lamotrigine, requiring careful dose titration?", o: ["Stevens-Johnson syndrome", "Kidney stones", "Hair loss"], a: "Stevens-Johnson syndrome", damage: 55, focusLoss: 2 } } ], xp: 120 } ] },
            chrono: { name: "Chrono Labs ⏳", icon: '⏳', order: 3, unlocksAfter: 'neuro', missions: [ { id: "c1", name: "Temporal Echoes", q: "What cellular process involving chromosome end shortening is linked to aging?", o: ["Mitosis", "Meiosis", "Telomere Shortening", "Apoptosis"], a: "Telomere Shortening", xp: 30 }, { id: "c2", name: "Half-Life Protocols", q: "Approximate biological half-life of caffeine in most adults?", o: ["30 minutes", "1-2 hours", "4-6 hours", "24 hours"], a: "4-6 hours", xp: 30, timeLimit: 15 }, { id: "c_boss", name: "Temporal Anomaly", boss: true, hp: 150, playerBaseFocus: 2, rewards: { currency: 100, items: { hintToken: 1 } }, svgPath: "M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z", questions: [ { easy: { q: "Is Progeria related to aging?", o: ["Yes", "No"], a: "Yes", damage: 40, focusLoss: 1 }, medium: { q: "Progeria is caused by a mutation in which gene?", o: ["LMNA", "FBN1", "CFTR"], a: "LMNA", damage: 50, focusLoss: 1 }, hard: { q: "The abnormal protein produced in Progeria affects the structure of what cellular component?", o: ["Mitochondria", "Cell membrane", "Nuclear envelope"], a: "Nuclear envelope", damage: 70, focusLoss: 2 } }, { easy: { q: "Does 'Senescence' mean cell division stops?", o: ["Yes", "No"], a: "Yes", damage: 40, focusLoss: 1 }, medium: { q: "The Hayflick limit applies primarily to which type of cells?", o: ["Cancer cells", "Normal somatic cells", "Stem cells"], a: "Normal somatic cells", damage: 50, focusLoss: 1 }, hard: { q: "Which enzyme, often reactivated in cancer cells, counteracts the Hayflick limit by maintaining telomere length?", o: ["DNA Polymerase", "Helicase", "Telomerase"], a: "Telomerase", damage: 70, focusLoss: 2 } } ], xp: 150 } ] },
            immuno: {
                name: "Immuno-Citadel 🛡️",
                icon: '🛡️',
                order: 4,
                unlocksAfter: 'chrono',
                missions: [
                    { id: "i1", name: "The Autoimmune Crisis", q: "Which cells are responsible for attacking pathogens?", o: ["T-cells", "B-cells", "Macrophages", "Neutrophils"], a: "T-cells", xp: 30 },
                    { id: "i_boss", name: "Sentinel of Self-Tolerance", boss: true, hp: 150, playerBaseFocus: 3, rewards: { currency: 100, items: { focusVial: 1 } }, svgPath: "M12 2l9 21H3L12 2z", questions: [ /* Boss questions */ ], xp: 150 }
                ]
            },
            pharmakon: {
                name: "Pharmakon Vaults ⚗️",
                icon: '⚗️',
                order: 5,
                unlocksAfter: 'immuno',
                missions: [
                    { id: "p1", name: "The Chemical Chaos", q: "What is the antidote for opioid overdose?", o: ["Naloxone", "Atropine", "Epinephrine", "Diazepam"], a: "Naloxone", xp: 35 },
                    { id: "p_boss", name: "The Dread Formulator", boss: true, hp: 180, playerBaseFocus: 3, rewards: { currency: 120, items: { hintToken: 1 } }, svgPath: "M6 18L18 6M6 6l12 12", questions: [ /* Boss questions */ ], xp: 180 }
                ]
            },
            respiratory: {
                name: "Respiratory Stratos 🌬️",
                icon: '🌬️',
                order: 6,
                unlocksAfter: 'pharmakon',
                missions: [
                    { id: "r1", name: "The Breathless Abyss", q: "What is the primary gas exchanged in the lungs?", o: ["Oxygen", "Carbon Dioxide", "Nitrogen", "Helium"], a: "Oxygen", xp: 40 },
                    { id: "r_boss", name: "The Gaseous Warden", boss: true, hp: 200, playerBaseFocus: 3, rewards: { currency: 150 }, svgPath: "M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z", questions: [ /* Boss questions */ ], xp: 200 }
                ]
            },
            endocrine: {
                name: "Endocrine Isles 🔮",
                icon: '🔮',
                order: 7,
                unlocksAfter: 'respiratory',
                missions: [
                    { id: "e1", name: "The Hormonal Storm", q: "Which gland is known as the 'master gland'?", o: ["Pituitary", "Thyroid", "Adrenal", "Pancreas"], a: "Pituitary", xp: 45 },
                    { id: "e_boss", name: "The Overlord of Overproduction", boss: true, hp: 220, playerBaseFocus: 3, rewards: { currency: 180 }, svgPath: "M5 11a7 7 0 1114 0 7 7 0 01-14 0z", questions: [ /* Boss questions */ ], xp: 220 }
                ]
            },
            renal: {
                name: "Renal Abyss 🌊",
                icon: '🌊',
                order: 8,
                unlocksAfter: 'endocrine',
                missions: [
                    { id: "ra1", name: "The Filtration Crisis", q: "What is the functional unit of the kidney?", o: ["Nephron", "Glomerulus", "Tubule", "Ureter"], a: "Nephron", xp: 50 },
                    { id: "ra_boss", name: "The Monsoon Leviathan", boss: true, hp: 250, playerBaseFocus: 3, rewards: { currency: 200 }, svgPath: "M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z", questions: [ /* Boss questions */ ], xp: 250 }
                ]
            },
            oncocrypts: {
                name: "Oncocrypts 🧬",
                icon: '🧬',
                order: 9,
                unlocksAfter: 'renal',
                missions: [
                    { id: "o1", name: "The Genetic Maze", q: "What is the term for uncontrolled cell growth?", o: ["Cancer", "Apoptosis", "Necrosis", "Mitosis"], a: "Cancer", xp: 60 },
                    { id: "o_boss", name: "The Grand Malignant", boss: true, hp: 300, playerBaseFocus: 3, rewards: { currency: 250 }, svgPath: "M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z", questions: [ /* Boss questions */ ], xp: 300 }
                ]
            },
            nexus: {
                name: "The Heart of the Odyssey",
                icon: '💠',
                order: 10,
                unlocksAfter: 'oncocrypts',
                missions: [
                    { id: "final_boss", name: "Sentinel 734", boss: true, hp: 500, playerBaseFocus: 4, rewards: { currency: 500 }, svgPath: "M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z", questions: [ /* Final boss questions */ ], xp: 500 }
                ]
            }
        };

        // --- Global Variables ---
        let levelEl, xpEl, nextXpEl, streakEl, xpBarFillEl, worldsContainer,
            worldSelectScreen, missionSelectScreen, challengeScreen, worldTitleEl,
            missionListEl, challengeTitleEl, questionEl, optionsEl, feedbackEl,
            nextBtn, bgMusicEl, toggleMusicBtn, musicIconOn, musicIconOff, musicBtnText,
            achievementToastEl, achievementsModalEl, achievementsListEl, perksModalEl,
            perksListEl, skillPointsDisplayEl, settingsModalEl, musicVolumeSlider, sfxVolumeSlider,
            statsModalEl, statsListEl, shopModalEl, shopItemsListEl, shopCurrencyDisplayEl, // Added Shop elements
            summaryModalEl, summaryTitleEl, summaryDetailsEl, // Added Summary elements
            bossBattleUI, bossNameEl, bossHpFillEl, bossHpTextEl, bossStatusEl, bossVisualEl,
            playerFocusFillEl, playerFocusTextEl, itemsUiEl, skillPointsStatEl, currencyStatEl, // Added currency stat display
            timerDisplayEl, modifierDisplayEl, difficultyChoiceEl, difficultySettingsButtonsEl; // Added difficulty settings buttons

        // --- Core Game Logic ---
        let currentWorldId = null;
        let currentMission = null;
        let originalMissionData = null;
        let currentBossState = null;
        let activeScreenId = 'world-select-screen';
        let streakSavedThisSession = false;
        let challengeTimerInterval = null;
        let remainingTime = 0;
        let hintUsedThisQuestion = false;
        let missionSummaryData = {};

        // --- Screen Navigation ---
        const switchScreen = (newScreenId) => { if (activeScreenId === newScreenId) return; const newScreen = document.getElementById(newScreenId); const currentScreen = document.getElementById(activeScreenId); if (currentScreen) currentScreen.classList.add('hidden'); if (newScreen) newScreen.classList.remove('hidden'); activeScreenId = newScreenId; window.scrollTo(0, 0); };

        // --- Modal Management ---
        const openModal = (modalId) => { const modal = document.getElementById(modalId); if (!modal) return; playSound('click'); if (modalId === 'achievements-modal') populateAchievementsModal(); if (modalId === 'perks-modal') populatePerksModal(); if (modalId === 'settings-modal') loadSettings(); if (modalId === 'stats-modal') populateStatsModal(); if (modalId === 'shop-modal') populateShopModal(); modal.classList.remove('modal-hidden'); modal.classList.add('modal-visible'); };
        const closeModal = (modalId) => { const modal = document.getElementById(modalId); if (!modal) return; playSound('click'); modal.classList.add('modal-hidden'); modal.classList.remove('modal-visible'); };

        // --- Achievements Logic ---
        const showAchievementToast = (achievementId) => { const achievement = gameData.achievements[achievementId]; if (!achievement || !achievementToastEl) return; playSound('achievement'); achievementToastEl.className = 'bg-gradient-to-r from-yellow-400 to-amber-500 text-gray-900 p-4 rounded-lg shadow-lg border border-yellow-600 flex items-center space-x-3 fixed top-4 left-1/2 transform -translate-x-1/2 z-50'; achievementToastEl.style.animation = 'none'; achievementToastEl.offsetHeight; achievementToastEl.style.animation = 'slide-in-out 4s ease-in-out forwards'; achievementToastEl.innerHTML = `<svg class="icon w-6 h-6 text-yellow-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><div> <p class="font-semibold">Achievement Unlocked!</p> <p class="text-sm">${achievement.name}</p> </div>`; };
        const checkAchievements = () => { let newAchievementUnlocked = false; if (!player.stats) player.stats = {}; Object.entries(gameData.achievements).forEach(([id, achievement]) => { if (!player.unlockedAchievements.includes(id)) { if (achievement.condition(player)) { player.unlockedAchievements.push(id); showAchievementToast(id); newAchievementUnlocked = true; } } }); if (newAchievementUnlocked) { saveGame(); if (achievementsModalEl && !achievementsModalEl.classList.contains('modal-hidden')) { populateAchievementsModal(); } } };
        const populateAchievementsModal = () => { if (!achievementsListEl) return; achievementsListEl.innerHTML = ''; const allAchievementIds = Object.keys(gameData.achievements); const unlockedIds = player.unlockedAchievements; const lockedIds = allAchievementIds.filter(id => !unlockedIds.includes(id)); if (unlockedIds.length === 0 && lockedIds.length === 0) { achievementsListEl.innerHTML = '<p class="text-gray-400 italic">No achievements defined.</p>'; return; } if (unlockedIds.length === 0) { achievementsListEl.innerHTML = '<p class="text-gray-400 italic">No achievements unlocked yet.</p>'; } else { unlockedIds.forEach(id => { const achievement = gameData.achievements[id]; const el = document.createElement('div'); el.className = 'bg-green-800/50 border border-green-600 p-3 rounded-lg flex items-center space-x-3'; el.innerHTML = `<svg class="icon w-6 h-6 text-green-400 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg><div><p class="font-semibold text-green-300">${achievement.name}</p><p class="text-sm text-gray-300">${achievement.description}</p></div>`; achievementsListEl.appendChild(el); }); } lockedIds.forEach(id => { const achievement = gameData.achievements[id]; const el = document.createElement('div'); el.className = 'bg-gray-700/50 border border-gray-600 p-3 rounded-lg flex items-center space-x-3 opacity-60'; el.innerHTML = `<svg class="icon w-6 h-6 text-gray-500 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg><div><p class="font-semibold text-gray-400">${achievement.name}</p><p class="text-sm text-gray-500">${achievement.description}</p></div>`; achievementsListEl.appendChild(el); }); };

        // --- Perks Logic ---
        const getPerkValue = (effectTarget) => { return player.unlockedPerks.reduce((total, perkId) => { const perk = gameData.perks[perkId]; if (perk && perk.type === 'passive' && perk.effectTarget === effectTarget) { return total + (perk.value || 0); } return total; }, 0); };
        const hasPerk = (perkId) => player.unlockedPerks.includes(perkId);
        const populatePerksModal = () => { if (!perksListEl || !skillPointsDisplayEl) return; perksListEl.innerHTML = ''; skillPointsDisplayEl.textContent = player.skillPoints; Object.entries(gameData.perks).forEach(([id, perk]) => { const isUnlocked = player.unlockedPerks.includes(id); const canAfford = player.skillPoints >= perk.cost; const meetsLevelReq = player.level >= perk.requiresLevel; const meetsPerkReq = !perk.requiresPerk || player.unlockedPerks.includes(perk.requiresPerk); const canUnlock = !isUnlocked && canAfford && meetsLevelReq && meetsPerkReq; const el = document.createElement('div'); el.className = `border p-3 rounded-lg flex justify-between items-center ${ isUnlocked ? 'bg-purple-800/50 border-purple-600' : 'bg-gray-700/50 border-gray-600' } ${!meetsLevelReq || !meetsPerkReq ? 'opacity-50' : ''}`; let requirementText = `Requires Level ${perk.requiresLevel}`; if (perk.requiresPerk) { const reqPerk = gameData.perks[perk.requiresPerk]; requirementText += `, requires ${reqPerk?.name || 'previous perk'}`; } el.innerHTML = `<div><p class="font-semibold ${isUnlocked ? 'text-purple-300' : 'text-gray-300'}">${perk.name}</p><p class="text-sm ${isUnlocked ? 'text-gray-300' : 'text-gray-400'}">${perk.description}</p><p class="text-xs ${isUnlocked ? 'text-gray-400' : 'text-gray-500'}">${requirementText}</p></div><button onclick="unlockPerk('${id}')" class="perk-button bg-green-600 hover:bg-green-500 text-white text-xs font-semibold py-1 px-3 rounded-full transition duration-200 ${isUnlocked || !canUnlock ? 'hidden' : ''}"> Unlock (${perk.cost} SP) </button><span class="text-xs font-semibold text-green-400 ${isUnlocked ? '' : 'hidden'}">Unlocked</span><span class="text-xs font-semibold text-red-400 ${!isUnlocked && (!meetsLevelReq || !meetsPerkReq) ? '' : 'hidden'}">Locked</span><span class="text-xs font-semibold text-yellow-400 ${!isUnlocked && !canAfford && meetsLevelReq && meetsPerkReq ? '' : 'hidden'}">Cost: ${perk.cost} SP</span>`; perksListEl.appendChild(el); }); if (Object.keys(gameData.perks).length === 0) { perksListEl.innerHTML = '<p class="text-gray-400 italic">No perks defined yet.</p>'; } };
        const unlockPerk = (perkId) => { const perk = gameData.perks[perkId]; if (!perk || player.unlockedPerks.includes(perkId)) return; const canAfford = player.skillPoints >= perk.cost; const meetsLevelReq = player.level >= perk.requiresLevel; const meetsPerkReq = !perk.requiresPerk || player.unlockedPerks.includes(perk.requiresPerk); if (canAfford && meetsLevelReq && meetsPerkReq) { playSound('perkUnlock'); player.skillPoints -= perk.cost; player.unlockedPerks.push(perkId); saveGame(); populatePerksModal(); updateStats(); checkAchievements(); } else { playSound('incorrect'); } };

        // --- Settings Logic ---
        const loadSettings = () => { if (!musicVolumeSlider || !sfxVolumeSlider || !difficultySettingsButtonsEl) return; musicVolumeSlider.value = player.settings.musicVolume; sfxVolumeSlider.value = player.settings.sfxVolume; applySettings(); difficultySettingsButtonsEl.querySelectorAll('button').forEach(btn => { btn.classList.toggle('active', btn.dataset.difficulty === player.settings.difficulty); }); };
        const applySettings = () => { if (!bgMusicEl || !sfxDestination) return; bgMusicEl.volume = player.settings.musicVolume; sfxDestination.volume.value = Tone.gainToDb(player.settings.sfxVolume); };
        const updateSetting = (type, value) => { const numericValue = parseFloat(value); if (type === 'musicVolume') { player.settings.musicVolume = numericValue; } else if (type === 'sfxVolume') { player.settings.sfxVolume = numericValue; } applySettings(); saveGame(); };
        const setDifficulty = (difficulty) => { if (!['easy', 'normal', 'hard'].includes(difficulty)) return; playSound('click'); player.settings.difficulty = difficulty; saveGame(); loadSettings(); console.log(`Difficulty set to: ${difficulty}`); };
        const getDifficultyMultiplier = (type) => { const difficulty = player.settings.difficulty || 'normal'; if (type === 'xp') { if (difficulty === 'easy') return 0.8; if (difficulty === 'hard') return 1.2; return 1.0; } if (type === 'focusLoss') { if (difficulty === 'hard') return 1.5; return 1.0; } if (type === 'currency') { if (difficulty === 'easy') return 0.75; if (difficulty === 'hard') return 1.25; return 1.0; } return 1.0; };
        const resetGame = () => { playSound('click'); if (window.confirm("Are you sure you want to reset all game data? This cannot be undone!")) { localStorage.removeItem(SAVE_KEY); location.reload(); } };

        // --- Statistics Logic ---
        const trackStat = (statName, value = 1) => { if (!player.stats) player.stats = {}; player.stats[statName] = (player.stats[statName] || 0) + value; if (statName === 'streakUpdate' && value > (player.stats.highestStreak || 0)) { player.stats.highestStreak = value; } };
        const populateStatsModal = () => { if (!statsListEl) return; const stats = player.stats || {}; const accuracy = (stats.totalCorrect || 0) + (stats.totalIncorrect || 0) > 0 ? ((stats.totalCorrect || 0) / ((stats.totalCorrect || 0) + (stats.totalIncorrect || 0)) * 100).toFixed(1) + '%' : 'N/A'; statsListEl.innerHTML = `<p><strong>Missions Completed:</strong> ${stats.missionsCompleted || 0}</p><p><strong>Bosses Defeated:</strong> ${stats.bossesDefeated || 0}</p><p><strong>Total Correct Answers:</strong> ${stats.totalCorrect || 0}</p><p><strong>Total Incorrect Answers:</strong> ${stats.totalIncorrect || 0}</p><p><strong>Overall Accuracy:</strong> ${accuracy}</p><p><strong>Highest Streak:</strong> ${stats.highestStreak || 0}</p><p><strong>Focus Vials Used:</strong> ${stats.vialsUsed || 0}</p><p><strong>Hint Tokens Used:</strong> ${stats.hintsUsed || 0}</p><p><strong>Perfect Boss Wins:</strong> ${stats.perfectBossWins || 0}</p><p><strong>Timed Missions Won:</strong> ${stats.timedWins || 0}</p><p><strong>Items Bought:</strong> ${stats.itemsBought || 0}</p>`; };


        // --- Update Stats & Level Up ---
        const updateStats = (leveledUp = false, pointsGained = 0) => { if (!levelEl || !xpEl || !nextXpEl || !streakEl || !xpBarFillEl || !skillPointsStatEl || !currencyStatEl) return; levelEl.textContent = player.level; xpEl.textContent = player.xp; const nextLevelXP = xpPerLevel(player.level); nextXpEl.textContent = nextLevelXP; streakEl.textContent = player.streak; trackStat('streakUpdate', player.streak); const xpPercentage = Math.min(100, (player.xp / nextLevelXP) * 100); xpBarFillEl.style.width = `${xpPercentage}%`; skillPointsStatEl.textContent = player.skillPoints; currencyStatEl.textContent = `${player.currency} 🪙`; if (leveledUp) { playSound('levelUp'); levelEl.classList.add('level-up-animation', 'text-lime-300'); if (pointsGained > 0 && feedbackEl) { feedbackEl.textContent = `Level Up! +${pointsGained} Skill Point${pointsGained > 1 ? 's' : ''}!`; feedbackEl.className += ' text-purple-400'; } setTimeout(() => { levelEl.classList.remove('level-up-animation', 'text-lime-300'); if (feedbackEl && feedbackEl.textContent.includes("Level Up!")) feedbackEl.textContent = ''; }, 2500); } saveGame(); checkAchievements(); };
        const checkLevelUp = () => { let leveledUp = false; let pointsGained = 0; while (player.xp >= xpPerLevel(player.level)) { player.xp -= xpPerLevel(player.level); player.level++; player.skillPoints++; pointsGained++; leveledUp = true; } updateStats(leveledUp, pointsGained); };

        // --- World Unlocking Logic ---
        const isWorldUnlocked = (worldId, worldData) => { if (worldData.order === 1) return true; if (!worldData.unlocksAfter) return true; const previousWorldId = worldData.unlocksAfter; const previousWorld = gameData[previousWorldId]; if (!previousWorld) return false; const previousBossMission = previousWorld.missions.find(m => m.boss); if (!previousBossMission) return true; return player.progress[previousWorldId]?.includes(previousBossMission.id) || false; };

        // --- Display World Selection ---
        const showWorlds = () => { if (!worldsContainer) return; worldsContainer.innerHTML = ''; const worldEntries = Object.entries(gameData).filter(([id, data]) => data.order).sort(([,a], [,b]) => a.order - b.order); worldEntries.forEach(([id, world]) => { const unlocked = isWorldUnlocked(id, world); const worldCard = document.createElement('button'); worldCard.className = `p-5 rounded-lg shadow-md text-left transition duration-200 ease-in-out transform focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-60 flex items-center space-x-4 ${ unlocked ? 'bg-gray-700/70 hover:bg-gray-600/90 hover:scale-[1.03] cursor-pointer' : 'bg-gray-800/50 opacity-50 cursor-not-allowed' }`; let unlockText = ''; if (!unlocked && world.unlocksAfter) { const prevWorld = gameData[world.unlocksAfter]; unlockText = `<span class="text-xs text-red-400 block mt-1">Requires completion of ${prevWorld?.name || 'previous realm'}</span>`; } worldCard.innerHTML = `<span class="text-3xl">${world.icon || '🌐'}</span><div><strong class="text-lg ${unlocked ? 'text-blue-300' : 'text-gray-500'} block mb-0.5 font-title">${world.name}</strong><span class="text-sm ${unlocked ? 'text-gray-400' : 'text-gray-600'}">Explore ${world.missions.length} challenges</span>${unlockText}</div>${!unlocked ? '<svg class="icon w-6 h-6 text-gray-600 ml-auto flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>' : ''} `; if (unlocked) { worldCard.onclick = () => { playSound('click'); selectWorld(id); }; } else { worldCard.disabled = true; } worldsContainer.appendChild(worldCard); }); switchScreen('world-select-screen'); };

        // --- Select World ---
        const selectWorld = (worldId) => { if (!worldTitleEl || !missionListEl) return; currentWorldId = worldId; const world = gameData[worldId]; worldTitleEl.textContent = world.name; missionListEl.innerHTML = ''; if (!player.progress[worldId]) player.progress[worldId] = []; world.missions.forEach((mission, index) => { const isCompleted = player.progress[worldId].includes(mission.id); const previousMission = world.missions[index - 1]; const isPreviousComplete = previousMission ? player.progress[worldId].includes(previousMission.id) : true; const isUnlocked = index === 0 || isPreviousComplete; const btn = document.createElement('button'); const bossIcon = mission.boss ? `<svg class="icon icon-sm text-red-400 ml-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>` : ''; const completedIcon = isCompleted ? `<svg class="icon text-green-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>` : `<svg class="icon text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`; btn.className = `w-full text-left p-3 rounded-lg transition duration-200 ease-in-out flex justify-between items-center focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 ${ isUnlocked ? 'bg-indigo-700 hover:bg-indigo-600 text-white shadow-md' : 'bg-gray-600/50 text-gray-400 cursor-not-allowed opacity-70' } ${mission.boss ? 'border-l-4 border-red-500/70' : 'border-l-4 border-blue-500/70'}`; btn.innerHTML = `<span class="flex items-center"> ${mission.name} ${bossIcon}</span> ${completedIcon}`; if (isUnlocked) { btn.onclick = () => { playSound('click'); loadMission(mission); }; } else { btn.disabled = true; } missionListEl.appendChild(btn); }); switchScreen('mission-select-screen'); };

        // --- Go Back ---
        const goBackToWorlds = () => { playSound('click'); currentWorldId = null; switchScreen('world-select-screen'); };

        // --- Timer Logic ---
        const stopTimer = () => { if (challengeTimerInterval) { clearInterval(challengeTimerInterval); challengeTimerInterval = null; } if(timerDisplayEl) { timerDisplayEl.textContent = ''; timerDisplayEl.classList.remove('text-red-500', 'animate-pulse'); } };
        const startTimer = (limit) => { stopTimer(); const difficulty = player.settings.difficulty || 'normal'; let adjustedLimit = limit; if (difficulty === 'easy') adjustedLimit = Math.round(limit * 1.25); if (difficulty === 'hard') adjustedLimit = Math.round(limit * 0.75); remainingTime = adjustedLimit; if (!timerDisplayEl) return; timerDisplayEl.textContent = remainingTime; challengeTimerInterval = setInterval(() => { remainingTime--; timerDisplayEl.textContent = remainingTime; if (remainingTime <= 5) { timerDisplayEl.classList.add('text-red-500', 'animate-pulse'); playSound('timerTick'); } else { timerDisplayEl.classList.remove('text-red-500', 'animate-pulse'); } if (remainingTime <= 0) { handleTimeout(); } }, 1000); };
        const handleTimeout = () => { stopTimer(); playSound('timerEnd'); feedbackEl.textContent = "Time's Up!"; feedbackEl.className += ' text-red-400'; disableOptions(); if (currentMission?.boss && currentBossState) { currentBossState.focus--; currentBossState.focusLostThisFight++; trackStat('totalIncorrect'); updatePlayerFocusUI(); if (currentBossState.focus <= 0) { loadNextBossQuestion(); return; } } else { trackStat('totalIncorrect'); const hasStreakSaver = hasPerk('streakSaver'); if (!hasStreakSaver || streakSavedThisSession) { player.streak = 0; } else { feedbackEl.textContent += " (Streak Saved!)"; streakSavedThisSession = true; } updateStats(); } if (nextBtn) { nextBtn.classList.remove('hidden'); if (currentMission?.boss && currentBossState?.focus > 0) { nextBtn.onclick = () => { currentBossState.questionIndex++; loadNextBossQuestion(); }; nextBtn.innerHTML = `<svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M13 7l5 5m0 0l-5 5m5-5H6" /></svg> Next Phase`; } else if (!currentMission?.boss) { nextBtn.onclick = () => showSummaryModal(false); /* Show summary on timeout fail */ nextBtn.innerHTML = `<svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M13 7l5 5m0 0l-5 5m5-5H6" /></svg> View Summary`; } } };


        // --- Load Mission ---
        const loadMission = (missionData) => {
            if (!challengeTitleEl || !questionEl || !optionsEl || !feedbackEl || !nextBtn || !bossBattleUI || !itemsUiEl || !modifierDisplayEl || !timerDisplayEl || !bossVisualEl || !difficultyChoiceEl) return;
            stopTimer(); hintUsedThisQuestion = false; originalMissionData = { ...missionData }; currentMission = { ...missionData }; modifierDisplayEl.textContent = ''; modifierDisplayEl.classList.remove('p-1', 'bg-purple-900/50', 'rounded'); const modifierKeys = Object.keys(gameData.modifiers); if (modifierKeys.length > 0 && Math.random() < 0.25) { const randomModifierId = modifierKeys[Math.floor(Math.random() * modifierKeys.length)]; const modifier = gameData.modifiers[randomModifierId]; if (modifier?.apply) { currentMission = modifier.apply(currentMission); modifierDisplayEl.textContent = `Modifier: ${modifier.name} - ${modifier.description}`; modifierDisplayEl.classList.add('p-1', 'bg-purple-900/50', 'rounded'); } } else { currentMission.modifierId = null; }
            challengeTitleEl.textContent = currentMission.name; questionEl.textContent = ''; optionsEl.innerHTML = ''; feedbackEl.textContent = ''; feedbackEl.className = 'text-center font-semibold min-h-[1.5em] mb-5'; nextBtn.classList.add('hidden'); nextBtn.onclick = () => showSummaryModal(); nextBtn.innerHTML = `<svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M13 7l5 5m0 0l-5 5m5-5H6" /></svg> View Summary`; nextBtn.classList.remove('bg-yellow-600', 'hover:bg-yellow-500'); nextBtn.classList.add('bg-green-600', 'hover:bg-green-500'); populateItemsUI(); bossVisualEl.innerHTML = ''; bossVisualEl.classList.remove('visible', 'animate-slow-pulse'); difficultyChoiceEl.classList.add('hidden');
            questionEl.classList.add('hidden');
            missionSummaryData = { xpEarned: 0, currencyEarned: 0, itemsFound: {}, correctAnswers: 0, incorrectAnswers: 0, focusLost: 0, timed: !!currentMission.timeLimit, timeTaken: 0, startTime: Date.now() };

            if (currentMission.boss) {
                bossBattleUI.classList.remove('hidden'); bossNameEl.textContent = currentMission.name; let baseFocus = currentMission.playerBaseFocus || 3; if(currentMission.modifierId === 'lowFocus') baseFocus = Math.max(1, baseFocus); const bonusFocus = getPerkValue('maxFocus'); const maxFocus = baseFocus + bonusFocus; currentBossState = { maxHp: currentMission.hp, hp: currentMission.hp, maxFocus: maxFocus, focus: maxFocus, questionIndex: 0, questions: [...currentMission.questions], focusLostThisFight: 0, currentQuestionData: null }; updateBossUI(); updatePlayerFocusUI();
                if (currentMission.svgPath) {
                    bossVisualEl.innerHTML = `<div class="p-2 bg-gray-700/50 rounded-full inline-block animate-slow-pulse"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" class="stroke-red-500"><path stroke-linecap="round" stroke-linejoin="round" d="${currentMission.svgPath}" /></svg></div>`;
                    setTimeout(() => bossVisualEl.classList.add('visible'), 50);
                }
                loadNextBossQuestion();
            } else {
                bossBattleUI.classList.add('hidden');
                questionEl.classList.remove('hidden');
                questionEl.textContent = currentMission.q; currentMission.o.forEach(optionText => { optionsEl.appendChild(createOptionButton(optionText, () => handleRegularAnswer(optionText))); });
                 let timeLimit = currentMission.timeLimit; // Apply modifier if exists
                 if (currentMission.modifierId === 'timePressure' && !timeLimit) timeLimit = 15; // Add time limit if modifier present
                 if (timeLimit && timeLimit > 0) { startTimer(timeLimit); }
                 else { if(timerDisplayEl) timerDisplayEl.textContent = ''; timerDisplayEl.classList.remove('text-red-500', 'animate-pulse'); }
            }
            switchScreen('challenge-screen');
        };

        // --- Items Logic ---
        const populateItemsUI = () => { if (!itemsUiEl) return; itemsUiEl.innerHTML = ''; Object.entries(player.inventory).forEach(([itemId, count]) => { if (count > 0) { const itemData = gameData.items[itemId]; if (itemData) { const btn = document.createElement('button'); btn.className = 'item-button bg-teal-600 hover:bg-teal-500 text-white text-xs font-semibold py-1 px-3 rounded-full transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed'; btn.innerHTML = `${itemData.icon || '📦'} ${itemData.name} (${count})`; btn.onclick = () => useItem(itemId); let isDisabled = false; if (itemId === 'focusVial' && (!currentMission?.boss || !currentBossState || currentBossState.focus >= currentBossState.maxFocus)) isDisabled = true; if (itemId === 'hintToken' && (hintUsedThisQuestion || optionsEl.children.length <= 2 || difficultyChoiceEl.classList.contains('hidden') === false )) isDisabled = true; btn.disabled = isDisabled; itemsUiEl.appendChild(btn); } } }); };
        const useItem = (itemId) => { if (player.inventory[itemId] <= 0) return; let itemUsed = false; if (itemId === 'focusVial') { if (currentMission?.boss && currentBossState && currentBossState.focus < currentBossState.maxFocus) { playSound('itemUse'); currentBossState.focus++; updatePlayerFocusUI(); player.inventory[itemId]--; itemUsed = true; trackStat('vialsUsed'); trackStat('itemsUsed'); checkAchievements(); } else { playSound('incorrect'); feedbackEl.textContent = "Cannot use Focus Vial now."; feedbackEl.className += ' text-yellow-400'; setTimeout(() => { if(feedbackEl) feedbackEl.textContent = ''; }, 2000); } } else if (itemId === 'hintToken') { if (!hintUsedThisQuestion && optionsEl.children.length > 0 && (currentBossState?.currentQuestionData || !currentMission.boss)) { const correctAnswer = currentMission.boss ? currentBossState.currentQuestionData.a : currentMission.a; const incorrectButtons = Array.from(optionsEl.querySelectorAll('button:not(:disabled):not(.hint-removed)')).filter(btn => btn.textContent !== correctAnswer); if (incorrectButtons.length > 0) { playSound('itemUse'); const btnToRemove = incorrectButtons[Math.floor(Math.random() * incorrectButtons.length)]; btnToRemove.classList.add('hint-removed'); btnToRemove.disabled = true; player.inventory[itemId]--; hintUsedThisQuestion = true; itemUsed = true; trackStat('hintsUsed'); trackStat('itemsUsed'); checkAchievements(); } else { playSound('incorrect'); } } else { playSound('incorrect'); } } if (itemUsed) { saveGame(); populateItemsUI(); } };

        // --- Boss/Player UI Updates ---
        const updateBossUI = () => { if (!currentBossState || !bossHpFillEl || !bossHpTextEl) return; const hpPercentage = Math.max(0, (currentBossState.hp / currentBossState.maxHp) * 100); bossHpFillEl.style.width = `${hpPercentage}%`; bossHpTextEl.textContent = `${Math.max(0, currentBossState.hp)} / ${currentBossState.maxHp}`; bossHpFillEl.classList.toggle('bg-red-700', hpPercentage < 30); bossHpFillEl.classList.toggle('bg-yellow-500', hpPercentage >= 30 && hpPercentage < 60); bossHpFillEl.classList.toggle('bg-red-500', hpPercentage >= 60); };
        const updatePlayerFocusUI = () => { if (!currentBossState || !playerFocusFillEl || !playerFocusTextEl) return; const focusPercentage = Math.max(0, (currentBossState.focus / currentBossState.maxFocus) * 100); playerFocusFillEl.style.width = `${focusPercentage}%`; playerFocusTextEl.textContent = `${currentBossState.focus} / ${currentBossState.maxFocus}`; const focusBarParent = playerFocusFillEl.parentElement; if(focusBarParent) { focusBarParent.classList.toggle('animate-pulse', currentBossState.focus === 1); focusBarParent.classList.toggle('border-red-500', currentBossState.focus === 1); } populateItemsUI(); };

        // --- Boss Question/Answer Handling ---
        const loadNextBossQuestion = () => { if (!optionsEl || !feedbackEl || !bossStatusEl || !challengeTitleEl || !questionEl || !nextBtn || !bossVisualEl || !difficultyChoiceEl) return; stopTimer(); hintUsedThisQuestion = false; optionsEl.innerHTML = ''; feedbackEl.textContent = ''; feedbackEl.className = 'text-center font-semibold min-h-[1.5em] mb-5'; bossStatusEl.textContent = ''; bossVisualEl.classList.remove('hit'); questionEl.classList.add('hidden'); difficultyChoiceEl.classList.add('hidden'); if (currentBossState.hp <= 0) { challengeTitleEl.textContent = `${currentMission.name} - Defeated!`; questionEl.textContent = `Victory! You overcame the challenge.`; questionEl.classList.remove('hidden'); playSound('levelUp'); bossStatusEl.textContent = 'Vanquished!'; bossStatusEl.className = 'text-center text-sm text-green-400 mt-1 font-bold'; if(bossBattleUI) bossBattleUI.classList.add('opacity-50'); let firstTimeDefeat = false; if (!player.progress[currentWorldId]?.includes(originalMissionData.id)) { player.progress[currentWorldId].push(originalMissionData.id); firstTimeDefeat = true; trackStat('bossesDefeated'); } if (currentBossState.focusLostThisFight === 0) { trackStat('perfectBossWins'); } const baseXP = originalMissionData.xp || 100; const difficultyMultiplierXP = getDifficultyMultiplier('xp'); const earnedXP = Math.round(baseXP * difficultyMultiplierXP); player.xp += earnedXP; missionSummaryData.xpEarned = earnedXP; const baseCurrency = originalMissionData.rewards?.currency || 50; const difficultyMultiplierCurrency = getDifficultyMultiplier('currency'); const earnedCurrency = Math.round(baseCurrency * difficultyMultiplierCurrency); player.currency += earnedCurrency; missionSummaryData.currencyEarned = earnedCurrency; if (firstTimeDefeat && originalMissionData.rewards?.items) { Object.entries(originalMissionData.rewards.items).forEach(([itemId, count]) => { player.inventory[itemId] = (player.inventory[itemId] || 0) + count; missionSummaryData.itemsFound[itemId] = (missionSummaryData.itemsFound[itemId] || 0) + count; }); } checkLevelUp(); checkAchievements(); saveGame(); nextBtn.classList.remove('hidden'); nextBtn.onclick = () => showSummaryModal(true); return; } if (currentBossState.focus <= 0) { challengeTitleEl.textContent = `${currentMission.name} - Overwhelmed!`; questionEl.textContent = `Your focus wavered. The challenge persists. Regroup and try again!`; questionEl.classList.remove('hidden'); playSound('defeat'); feedbackEl.textContent = "Focus Depleted!"; feedbackEl.className += ' text-red-400'; bossStatusEl.textContent = 'Challenge Failed'; bossStatusEl.className = 'text-center text-sm text-red-500 mt-1 font-bold'; optionsEl.innerHTML = '<p class="text-center text-gray-400 italic">Restart the challenge from the mission list.</p>'; disableOptions(); nextBtn.classList.remove('hidden'); nextBtn.onclick = () => showSummaryModal(false); nextBtn.innerHTML = `<svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg> View Summary`; nextBtn.classList.replace('bg-green-600', 'bg-yellow-600'); nextBtn.classList.replace('hover:bg-green-500', 'hover:bg-yellow-500'); return; } if (currentBossState.questionIndex >= currentBossState.questions.length) { console.warn("Boss ran out of questions but still has HP."); challengeTitleEl.textContent = `${currentMission.name} - Standoff`; questionEl.textContent = `The ${currentMission.name} endures! (No further challenges available this attempt)`; questionEl.classList.remove('hidden'); nextBtn.classList.remove('hidden'); nextBtn.onclick = () => showSummaryModal(false); return; } challengeTitleEl.textContent = `${currentMission.name} - Phase ${currentBossState.questionIndex + 1} - Choose Difficulty`; difficultyChoiceEl.classList.remove('hidden'); populateItemsUI(); };
        const showBossQuestion = (difficulty) => { if (!currentBossState || !difficultyChoiceEl || !questionEl || !optionsEl) return; playSound('click'); difficultyChoiceEl.classList.add('hidden'); const currentPhaseData = currentBossState.questions[currentBossState.questionIndex]; let questionData = currentPhaseData[difficulty]; if (!questionData) { console.error(`Missing question data for difficulty ${difficulty}`); questionData = currentPhaseData['medium'] || currentPhaseData['easy'] || currentPhaseData['hard']; if (!questionData) { feedbackEl.textContent = "Error loading question data!"; nextBtn.classList.remove('hidden'); return; } } currentBossState.currentQuestionData = questionData; challengeTitleEl.textContent = `${currentMission.name} - Phase ${currentBossState.questionIndex + 1}`; questionEl.textContent = questionData.q; questionEl.classList.remove('hidden'); optionsEl.innerHTML = ''; questionData.o.forEach(optionText => { optionsEl.appendChild(createOptionButton(optionText, () => handleBossAnswer(optionText, questionData.a))); }); if (currentMission.timeLimit && currentMission.timeLimit > 0) { startTimer(currentMission.timeLimit); } else { if(timerDisplayEl) timerDisplayEl.textContent = ''; timerDisplayEl.classList.remove('text-red-500', 'animate-pulse'); } populateItemsUI(); };
        const handleBossAnswer = (selectedOption, correctAnswer) => { stopTimer(); disableOptions(); const questionData = currentBossState.currentQuestionData; if (!questionData) { console.error("Error: Could not find question data for scoring."); setTimeout(() => { currentBossState.questionIndex++; loadNextBossQuestion(); }, 1500); return; } const isCorrect = selectedOption === correctAnswer; highlightAnswer(selectedOption, correctAnswer, isCorrect); if (isCorrect) { playSound('correct'); const damageDealt = questionData.damage || 30; feedbackEl.textContent = `Direct Hit! (${damageDealt} damage)`; feedbackEl.className += ' text-green-400'; currentBossState.hp -= damageDealt; missionSummaryData.correctAnswers++; trackStat('totalCorrect'); playSound('bossHit'); if(bossBattleUI) bossBattleUI.classList.add('shake'); if(bossVisualEl) { bossVisualEl.classList.add('hit'); setTimeout(() => bossVisualEl.classList.remove('hit'), 300); } setTimeout(() => {if(bossBattleUI) bossBattleUI.classList.remove('shake')}, 400); updateBossUI(); setTimeout(() => { currentBossState.questionIndex++; loadNextBossQuestion(); }, 1200); } else { playSound('incorrect'); playSound('playerHit'); const baseFocusLoss = questionData.focusLoss || 1; const difficultyMultiplierFocus = getDifficultyMultiplier('focusLoss'); const focusLossModifier = currentMission.baseFocusLossMultiplier || 1; // Apply fragile modifier
                 const focusLost = Math.max(1, Math.round(baseFocusLoss * difficultyMultiplierFocus * focusLossModifier)); feedbackEl.textContent = `Focus Lost! (-${focusLost}) Correct: ${correctAnswer}`; feedbackEl.className += ' text-red-400'; currentBossState.focus -= focusLost; currentBossState.focusLostThisFight += focusLost; missionSummaryData.incorrectAnswers++; missionSummaryData.focusLost += focusLost; trackStat('totalIncorrect'); const hasStreakSaver = hasPerk('streakSaver'); if (!hasStreakSaver || streakSavedThisSession) { player.streak = 0; } else { feedbackEl.textContent += " (Streak Saved!)"; streakSavedThisSession = true; } updateStats(); updatePlayerFocusUI(); const focusBarContainer = playerFocusFillEl?.parentElement?.parentElement?.parentElement; if(focusBarContainer) { focusBarContainer.classList.add('shake'); setTimeout(() => focusBarContainer.classList.remove('shake'), 400); } if(bossStatusEl) { bossStatusEl.textContent = 'Attack Dodged!'; bossStatusEl.className = 'text-center text-sm text-yellow-400 mt-1 animate-pulse'; } setTimeout(() => { currentBossState.questionIndex++; loadNextBossQuestion(); }, 2000); } currentBossState.currentQuestionData = null; };

        // --- Regular Mission Logic ---
        const handleRegularAnswer = (selectedOption) => { stopTimer(); disableOptions(); const correctAnswer = currentMission.a; const isCorrect = selectedOption === correctAnswer; highlightAnswer(selectedOption, correctAnswer, isCorrect); if (isCorrect) { playSound('correct'); const baseXP = currentMission.xp || 15; const difficultyMultiplierXP = getDifficultyMultiplier('xp'); const xpModifierPerk = getPerkValue('xpModifier'); const earnedXP = Math.round(baseXP * difficultyMultiplierXP * (1 + xpModifierPerk)); feedbackEl.textContent = `Correct! +${earnedXP} XP` + (xpModifierPerk > 0 ? ` (${Math.round(xpModifierPerk*100)}% bonus)` : ''); feedbackEl.className += ' text-green-400'; if (!player.progress[currentWorldId]?.includes(originalMissionData.id)) { trackStat('missionsCompleted'); } // Award currency for regular missions too
                 const baseCurrency = 5; // Smaller amount for regular missions
                 const difficultyMultiplierCurrency = getDifficultyMultiplier('currency');
                 const earnedCurrency = Math.round(baseCurrency * difficultyMultiplierCurrency);
                 player.currency += earnedCurrency;
                 missionSummaryData.currencyEarned += earnedCurrency; // Track for summary
                 player.xp += earnedXP; missionSummaryData.xpEarned += earnedXP; player.streak++; missionSummaryData.correctAnswers++; trackStat('totalCorrect'); checkLevelUp(); const itemDropChance = 0.05 + getPerkValue('itemDropRate'); if (Math.random() < itemDropChance) { const itemKeys = Object.keys(gameData.items); const randomItemId = itemKeys[Math.floor(Math.random() * itemKeys.length)]; player.inventory[randomItemId] = (player.inventory[randomItemId] || 0) + 1; feedbackEl.textContent += ` Found ${gameData.items[randomItemId].icon || ''} ${gameData.items[randomItemId].name}!`; missionSummaryData.itemsFound[randomItemId] = (missionSummaryData.itemsFound[randomItemId] || 0) + 1; } if (currentMission.timeLimit) { trackStat('timedWins'); } saveGame(); } else { playSound('incorrect'); feedbackEl.textContent = `Incorrect! Correct: ${correctAnswer}`; feedbackEl.className += ' text-red-400'; missionSummaryData.incorrectAnswers++; trackStat('totalIncorrect'); const hasStreakSaver = hasPerk('streakSaver'); if (!hasStreakSaver || streakSavedThisSession) { player.streak = 0; } else { feedbackEl.textContent += " (Streak Saved!)"; streakSavedThisSession = true; } updateStats(); } setTimeout(() => { if(nextBtn) { nextBtn.classList.remove('hidden'); nextBtn.onclick = () => showSummaryModal(isCorrect); } }, 800); };

        // --- Helper Functions ---
        const createOptionButton = (text, onClickAction) => { const btn = document.createElement('button'); btn.className = 'w-full text-left p-3 rounded-lg bg-gray-700/80 hover:bg-gray-600 border border-gray-600/50 hover:border-blue-500 transition duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-60 transform hover:scale-[1.02]'; btn.textContent = text; btn.onclick = () => { playSound('click'); onClickAction(); }; return btn; };
        const disableOptions = () => { if(optionsEl) optionsEl.querySelectorAll('button').forEach(b => b.disabled = true); };
        const highlightAnswer = (selected, correct, isCorrect) => { if(optionsEl) optionsEl.querySelectorAll('button:not(.hint-removed)').forEach(b => { b.classList.remove('hover:bg-gray-600', 'hover:border-blue-500', 'hover:scale-[1.02]'); if (b.textContent === correct) { b.classList.remove('bg-gray-700/80'); b.classList.add('bg-green-600/80', 'text-white', 'border-green-500', 'ring-2', 'ring-green-400/50', 'scale-[1.01]'); } else if (b.textContent === selected && !isCorrect) { b.classList.remove('bg-gray-700/80'); b.classList.add('bg-red-600/80', 'text-white', 'border-red-500', 'opacity-80'); } else { b.classList.add('opacity-50'); } }); };

        // --- Mission Summary Logic ---
        const showSummaryModal = (success) => { if (!summaryModalEl || !summaryTitleEl || !summaryDetailsEl) return; stopTimer(); missionSummaryData.timeTaken = missionSummaryData.startTime ? Math.round((Date.now() - missionSummaryData.startTime) / 1000) : 0; const accuracy = (missionSummaryData.correctAnswers + missionSummaryData.incorrectAnswers > 0) ? ((missionSummaryData.correctAnswers / (missionSummaryData.correctAnswers + missionSummaryData.incorrectAnswers)) * 100).toFixed(1) + '%' : 'N/A'; summaryTitleEl.textContent = success ? "Mission Complete!" : "Mission Failed!"; summaryTitleEl.className = `text-2xl font-semibold mb-4 ${success ? 'text-green-400' : 'text-red-400'}`; let detailsHtml = `<p><strong>XP Earned:</strong> ${missionSummaryData.xpEarned || 0}</p><p><strong>Credits Earned:</strong> ${missionSummaryData.currencyEarned || 0} 🪙</p><p><strong>Accuracy:</strong> ${accuracy} (${missionSummaryData.correctAnswers}/${missionSummaryData.correctAnswers + missionSummaryData.incorrectAnswers})</p>`; if (missionSummaryData.timed) { detailsHtml += `<p><strong>Time Taken:</strong> ${missionSummaryData.timeTaken}s</p>`; } if (currentMission?.boss) { detailsHtml += `<p><strong>Focus Lost:</strong> ${missionSummaryData.focusLost || 0}</p>`; } const itemsFoundEntries = Object.entries(missionSummaryData.itemsFound); if (itemsFoundEntries.length > 0) { detailsHtml += `<p><strong>Items Found:</strong></p><ul class="list-disc list-inside ml-4">`; itemsFoundEntries.forEach(([itemId, count]) => { const itemData = gameData.items[itemId]; detailsHtml += `<li>${itemData?.icon || ''} ${itemData?.name || itemId}: ${count}</li>`; }); detailsHtml += `</ul>`; } summaryDetailsEl.innerHTML = detailsHtml; openModal('summary-modal'); };
        const closeSummaryModal = () => { closeModal('summary-modal'); completeMissionFlow(); };
        const completeMissionFlow = () => { const wasBoss = currentMission?.boss; const wasBossDefeated = wasBoss && currentBossState?.hp <= 0; if (!currentBossState || currentBossState.focus > 0) { if (!player.progress[currentWorldId]?.includes(originalMissionData.id)) { if (!player.progress[currentWorldId]) player.progress[currentWorldId] = []; player.progress[currentWorldId].push(originalMissionData.id); saveGame(); } checkAchievements(); } if (wasBossDefeated) { showWorlds(); } else if (currentWorldId) { selectWorld(currentWorldId); } else { showWorlds(); } currentMission = null; originalMissionData = null; currentBossState = null; streakSavedThisSession = false; missionSummaryData = {}; };


        // --- Music Toggle & Init ---
        const toggleMusic = () => { if(!bgMusicEl || !musicIconOn || !musicIconOff || !musicBtnText || !toggleMusicBtn) return; playSound('click'); player.musicOn = !player.musicOn; if (player.musicOn) { setTimeout(() => { bgMusicEl.play().catch(e => console.error("Audio play failed in toggleMusic:", e)); }, 0); musicIconOn.classList.remove('hidden'); musicIconOff.classList.add('hidden'); musicBtnText.textContent = 'On'; toggleMusicBtn.classList.replace('bg-gray-600', 'bg-indigo-600'); toggleMusicBtn.classList.replace('hover:bg-gray-500', 'hover:bg-indigo-500'); } else { bgMusicEl.pause(); musicIconOn.classList.add('hidden'); musicIconOff.classList.remove('hidden'); musicBtnText.textContent = 'Off'; toggleMusicBtn.classList.replace('bg-indigo-600', 'bg-gray-600'); toggleMusicBtn.classList.replace('hover:bg-indigo-500', 'hover:bg-gray-500'); } saveGame(); };
        const initializeMusic = () => { if(!bgMusicEl || !musicIconOn || !musicIconOff || !musicBtnText || !toggleMusicBtn) return; bgMusicEl.volume = player.settings.musicVolume; if (player.musicOn) { musicIconOn.classList.remove('hidden'); musicIconOff.classList.add('hidden'); musicBtnText.textContent = 'On'; toggleMusicBtn.classList.replace('bg-gray-600', 'bg-indigo-600'); toggleMusicBtn.classList.replace('hover:bg-gray-500', 'hover:bg-indigo-500'); } else { bgMusicEl.pause(); musicIconOn.classList.add('hidden'); musicIconOff.classList.remove('hidden'); musicBtnText.textContent = 'Off'; toggleMusicBtn.classList.replace('bg-indigo-600', 'bg-gray-600'); toggleMusicBtn.classList.replace('hover:bg-indigo-500', 'hover:bg-gray-500'); } };
        const initializeSfxVolume = () => { if(sfxDestination) sfxDestination.volume.value = Tone.gainToDb(player.settings.sfxVolume); };

        // --- Shop Logic ---
        const populateShopModal = () => { if (!shopItemsListEl || !shopCurrencyDisplayEl) return; shopCurrencyDisplayEl.textContent = player.currency; shopItemsListEl.innerHTML = ''; Object.entries(gameData.items).forEach(([id, item]) => { if (item.price !== undefined) { const canAfford = player.currency >= item.price; const el = document.createElement('div'); el.className = `border p-3 rounded-lg flex justify-between items-center bg-gray-700/50 border-gray-600`; el.innerHTML = `<div class="flex items-center space-x-3"><span class="text-xl">${item.icon || '📦'}</span><div><p class="font-semibold text-gray-200">${item.name}</p><p class="text-sm text-gray-400">${item.description}</p></div></div><button onclick="buyItem('${id}')" class="shop-buy-button bg-green-600 hover:bg-green-500 text-white text-xs font-semibold py-1 px-3 rounded-full transition duration-200 disabled:bg-gray-500 disabled:cursor-not-allowed" ${!canAfford ? 'disabled' : ''}> Buy (${item.price} 🪙) </button>`; shopItemsListEl.appendChild(el); } }); if (shopItemsListEl.children.length === 0) { shopItemsListEl.innerHTML = '<p class="text-gray-400 italic">Nothing currently for sale.</p>'; } };
        const buyItem = (itemId) => { const item = gameData.items[itemId]; if (!item || item.price === undefined) return; if (player.currency >= item.price) { playSound('buyItem'); player.currency -= item.price; player.inventory[itemId] = (player.inventory[itemId] || 0) + 1; if (!player.stats) player.stats = {}; player.stats.itemsBought = (player.stats.itemsBought || 0) + 1; saveGame(); updateStats(); populateShopModal(); checkAchievements(); } else { playSound('incorrect'); } };


        // --- Initial Game Load ---
        document.addEventListener('DOMContentLoaded', () => {
            // Assign element variables
            levelEl = document.getElementById('level'); xpEl = document.getElementById('xp'); nextXpEl = document.getElementById('next-xp'); streakEl = document.getElementById('streak'); xpBarFillEl = document.getElementById('xp-bar-fill'); worldsContainer = document.getElementById('worlds'); worldSelectScreen = document.getElementById('world-select-screen'); missionSelectScreen = document.getElementById('mission-select-screen'); challengeScreen = document.getElementById('challenge-screen'); worldTitleEl = document.getElementById('world-title'); missionListEl = document.getElementById('mission-list'); challengeTitleEl = document.getElementById('challenge-title'); questionEl = document.getElementById('question'); optionsEl = document.getElementById('options'); feedbackEl = document.getElementById('feedback'); nextBtn = document.getElementById('next-btn'); bgMusicEl = document.getElementById('bg-music'); toggleMusicBtn = document.getElementById('toggle-music-btn'); musicIconOn = document.getElementById('music-icon-on'); musicIconOff = document.getElementById('music-icon-off'); musicBtnText = document.getElementById('music-btn-text'); achievementToastEl = document.getElementById('achievement-toast'); achievementsModalEl = document.getElementById('achievements-modal'); achievementsListEl = document.getElementById('achievements-list'); perksModalEl = document.getElementById('perks-modal'); perksListEl = document.getElementById('perks-list'); skillPointsDisplayEl = document.getElementById('skill-points-display'); settingsModalEl = document.getElementById('settings-modal'); musicVolumeSlider = document.getElementById('music-volume'); sfxVolumeSlider = document.getElementById('sfx-volume'); statsModalEl = document.getElementById('stats-modal'); statsListEl = document.getElementById('stats-list'); shopModalEl = document.getElementById('shop-modal'); shopItemsListEl = document.getElementById('shop-items-list'); shopCurrencyDisplayEl = document.getElementById('shop-currency-display'); summaryModalEl = document.getElementById('summary-modal'); summaryTitleEl = document.getElementById('summary-title'); summaryDetailsEl = document.getElementById('summary-details'); bossBattleUI = document.getElementById('boss-battle-ui'); bossNameEl = document.getElementById('boss-name'); bossHpFillEl = document.getElementById('boss-hp-fill'); bossHpTextEl = document.getElementById('boss-hp-text'); bossStatusEl = document.getElementById('boss-status'); bossVisualEl = document.getElementById('boss-visual'); playerFocusFillEl = document.getElementById('player-focus-fill'); playerFocusTextEl = document.getElementById('player-focus-text'); itemsUiEl = document.getElementById('items-ui'); skillPointsStatEl = document.getElementById('skill-points-stat'); currencyStatEl = document.getElementById('currency-stat'); timerDisplayEl = document.getElementById('timer-display'); modifierDisplayEl = document.getElementById('modifier-display'); difficultyChoiceEl = document.getElementById('difficulty-choice'); difficultySettingsButtonsEl = document.getElementById('difficulty-settings-buttons');

            // Add event listeners for settings sliders
            if (musicVolumeSlider) musicVolumeSlider.addEventListener('input', (e) => updateSetting('musicVolume', e.target.value));
            if (sfxVolumeSlider) sfxVolumeSlider.addEventListener('input', (e) => updateSetting('sfxVolume', e.target.value));

            // Initialize game state and UI
            initializeSfxVolume();
            initializeMusic();
            checkLevelUp(); // Includes initial stats update
            showWorlds();
            loadSettings(); // Ensure initial difficulty buttons are styled correctly
        });

    </script>

</body>
</html>
